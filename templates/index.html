<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#e91e63">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dream AI Girl">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <title>Dream AI Girl</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #0a0a0c; color: #ffffff; min-height: 100vh; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; overscroll-behavior: contain; }
        
        ::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
        * { scrollbar-width: none; -ms-overflow-style: none; }
        
        .gpu-accelerate { transform: translateZ(0); backface-visibility: hidden; perspective: 1000px; }
        
        img { content-visibility: auto; }
        img.lazy-load { opacity: 0; filter: blur(10px); transition: opacity 0.4s ease, filter 0.4s ease; }
        img.lazy-load.loaded { opacity: 1; filter: blur(0); }
        
        .skeleton { background: linear-gradient(90deg, #12121a 25%, #1a1a2e 50%, #12121a 75%); background-size: 200% 100%; animation: shimmer 1.2s ease-in-out infinite; border-radius: 8px; }
        .skeleton-circle { border-radius: 50%; }
        .skeleton-text { height: 14px; margin: 6px 0; }
        .skeleton-card { height: 240px; border-radius: 20px; }
        
        .photo-loading { position: relative; overflow: hidden; }
        .photo-loading::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.08) 50%, transparent 75%); background-size: 200% 100%; animation: shimmer 1.5s ease-in-out infinite; }
        .photo-initial { display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a2e 0%, #0d0d12 100%); font-weight: 700; color: rgba(233, 30, 99, 0.4); }
        .photo-bg { background-size: cover; background-position: center top; background-repeat: no-repeat; }
        .photo-retry { position: absolute; bottom: 10px; right: 10px; background: rgba(233, 30, 99, 0.8); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 0.7rem; cursor: pointer; z-index: 10; }
        .photo-fallback { display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a2e 0%, #2a2a4e 100%); color: rgba(233, 30, 99, 0.6); font-size: 3rem; font-weight: 700; }
        
        .page { display: none; min-height: 100vh; overflow-x: hidden; will-change: opacity, transform; }
        .page.page-enter { animation: pageSlideIn 0.3s ease forwards; }
        .page.page-exit { animation: pageSlideOut 0.2s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translate3d(0, 8px, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        @keyframes slideIn { from { opacity: 0; transform: translate3d(15px, 0, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        @keyframes pageSlideIn { from { opacity: 0; transform: translate3d(30px, 0, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        @keyframes pageSlideOut { from { opacity: 1; transform: translate3d(0, 0, 0); } to { opacity: 0; transform: translate3d(-30px, 0, 0); } }
        * { transition: background-color 0.15s ease-out, border-color 0.15s ease-out, color 0.15s ease-out, transform 0.15s ease-out, opacity 0.15s ease-out; }
        button { transition: transform 0.1s ease-out, background-color 0.15s ease-out; }
        button:active { transform: scale(0.95) !important; }
        img { transition: opacity 0.3s ease-out; }
        .skeleton { background: linear-gradient(90deg, #1a1a2e 25%, #2a2a4e 50%, #1a1a2e 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes slideUp { from { opacity: 0; transform: translate3d(0, 20px, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        @keyframes msgAppear { from { opacity: 0; transform: translate3d(0, 8px, 0); } to { opacity: 1; transform: translate3d(0, 0, 0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        .msg { animation: msgAppear 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94); will-change: transform, opacity; }
        
        .touch-feedback { transition: transform 0.1s ease, opacity 0.1s ease; }
        .touch-feedback:active { transform: scale(0.97); opacity: 0.9; }
        .page.active { display: flex; flex-direction: column; }
        
        /* LOGIN PAGE */
        .login-page { justify-content: center; align-items: center; padding: 2rem; }
        .login-box { max-width: 400px; width: 100%; text-align: center; }
        .login-logo { font-size: 3rem; font-weight: 800; color: #e91e63; margin-bottom: 0.5rem; }
        .login-subtitle { color: #888; font-size: 1rem; margin-bottom: 2rem; }
        .login-form { display: flex; flex-direction: column; gap: 1rem; }
        .login-input { padding: 1rem 1.5rem; background: #12121a; border: 1px solid #1a1a1f; border-radius: 15px; color: white; font-size: 1rem; outline: none; }
        .login-input:focus { border-color: #e91e63; }
        .login-btn { padding: 1.1rem; background: #e91e63; border: none; border-radius: 15px; color: white; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 1rem; transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.15s ease; }
        .login-btn:active { transform: scale(0.97); box-shadow: 0 2px 10px rgba(233, 30, 99, 0.3); }
        .auth-tabs { display: flex !important; margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: #2a2a4e; }
        .auth-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; background: #2a2a4e; color: #ffffff; border: none; font-size: 1rem; font-weight: 600; transition: all 0.2s; }
        .auth-tab.active { background: #e91e63; color: #ffffff; }
        .auth-error { color: #ff4757; font-size: 0.85rem; margin-top: 0.8rem; min-height: 1.2rem; }
        .forgot-password { color: #888; font-size: 0.85rem; margin-top: 1rem; cursor: pointer; text-align: center; }
        .forgot-password:hover { color: #e91e63; text-decoration: underline; }
        .photo-upload-section { margin-top: 0.5rem; }
        .photo-upload-label { display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 0.8rem; background: #1e1e2a; border-radius: 12px; }
        .photo-preview { width: 50px; height: 50px; border-radius: 50%; background: #2a2a3a; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #888; overflow: hidden; }
        .photo-preview img { width: 100%; height: 100%; object-fit: cover; }
        .photo-upload-label span { color: #888; font-size: 0.9rem; }
        
        /* HEADER */
        .header { padding: 1rem; text-align: center; background: rgba(10, 10, 12, 0.8); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(233, 30, 99, 0.1); }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 800; color: #e91e63; letter-spacing: -0.5px; }
        .user-name { color: #888; font-size: 0.8rem; }
        .subtitle { color: #888888; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; margin-top: 0.2rem; }
        
        /* NAV TABS */
        .nav-tabs { display: flex; justify-content: center; gap: 0.5rem; padding: 0.5rem; background: #0a0a0c; border-bottom: 1px solid #1a1a1f; }
        .nav-tab { padding: 0.6rem 1.2rem; background: #12121a; border: none; border-radius: 20px; color: #888; font-size: 0.8rem; cursor: pointer; }
        .nav-tab.active { background: #e91e63; color: white; }
        
        /* SWIPE PAGE - GPU ACCELERATED */
        .swipe-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 0.5rem; position: relative; perspective: 1000px; overflow: visible; height: calc(100vh - 280px); min-height: 350px; }
        .swipe-card { width: 95%; max-width: 350px; height: 100%; max-height: 480px; background: #12121a; border-radius: 25px; overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); will-change: transform, opacity; transform: translate3d(0, 0, 0); transition: none; backface-visibility: hidden; -webkit-backface-visibility: hidden; touch-action: pan-y; user-select: none; }
        .swipe-card.next-card { position: absolute; transform: translate3d(0, 0, -50px) scale(0.95); opacity: 0.7; z-index: 0; height: calc(100% - 20px); }
        .swipe-card.current-card { position: relative; z-index: 10; opacity: 1; }
        .swipe-card.animating { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-out; position: absolute; }
        .swipe-card.swipe-left { transform: translate3d(-120vw, 0, 0) rotate(-30deg); opacity: 0; position: absolute; }
        .swipe-card.swipe-right { transform: translate3d(120vw, 0, 0) rotate(30deg); opacity: 0; position: absolute; }
        .swipe-card-img { height: 70%; background: #1a1a2e; display: flex; align-items: center; justify-content: center; font-size: 6rem; font-weight: 800; color: rgba(233,30,99,0.2); overflow: hidden; position: relative; }
        .swipe-card-img img { width: 100%; height: 100%; object-fit: cover; will-change: transform; }
        .swipe-initial { font-size: 8rem; font-weight: 800; color: rgba(233,30,99,0.3); }
        .profile-initial { font-size: 5rem; font-weight: 800; color: rgba(233,30,99,0.3); }
        .card-initial, .msg-initial { font-size: 1.5rem; font-weight: 800; color: rgba(233,30,99,0.3); }
        .swipe-card-info { padding: 1.5rem; }
        .swipe-card-name { font-size: 1.5rem; font-weight: 700; }
        .swipe-card-location { color: #888; font-size: 0.9rem; margin-top: 0.3rem; }
        .swipe-card-bio { color: #aaa; font-size: 0.85rem; margin-top: 0.5rem; line-height: 1.4; }
        .swipe-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 800; opacity: 0; pointer-events: none; z-index: 100; }
        .swipe-overlay.like { color: #4CAF50; text-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
        .swipe-overlay.nope { color: #ff4444; text-shadow: 0 0 20px rgba(255, 68, 68, 0.5); }
        .swipe-buttons { display: flex; justify-content: center; gap: 2rem; padding: 1.5rem; position: relative; z-index: 20; }
        .swipe-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 2rem; cursor: pointer; transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.15s ease; will-change: transform; }
        .swipe-btn:active { transform: scale(0.85); }
        .swipe-btn-pass { background: #333; color: #ff4444; }
        .swipe-btn-like { background: #e91e63; color: white; box-shadow: 0 5px 20px rgba(233,30,99,0.4); }
        .no-more-cards { text-align: center; color: #666; padding: 2rem; }
        
        /* MATCH OVERLAY */
        #matchOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .match-title { font-size: 2.5rem; font-weight: 800; color: #e91e63; margin-bottom: 1rem; animation: pulse 1s ease-in-out infinite; }
        .match-girl-photo { width: 180px; height: 180px; border-radius: 50%; background: #12121a; border: 4px solid #e91e63; overflow: hidden; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; }
        .match-girl-photo img { width: 100%; height: 100%; object-fit: cover; }
        .match-girl-photo .match-initial { font-size: 4rem; font-weight: 800; color: rgba(233,30,99,0.4); }
        .match-girl-name { font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 1rem; }
        .match-heart-icon { font-size: 1.5rem; color: #e91e63; display: flex; align-items: center; }
        .match-photo-small { width: 60px !important; height: 60px !important; font-size: 1.5rem !important; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .match-photos { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; }
        .match-photo { width: 60px; height: 60px; border-radius: 50%; background: #12121a; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 800; color: rgba(233,30,99,0.3); border: 2px solid #e91e63; overflow: hidden; }
        .match-photo img { width: 100%; height: 100%; object-fit: cover; }
        .match-names { font-size: 1.2rem; color: white; margin-bottom: 2rem; }
        .match-btn { padding: 1rem 3rem; background: #e91e63; border: none; border-radius: 30px; color: white; font-size: 1rem; font-weight: 700; cursor: pointer; }
        .match-close { margin-top: 1rem; background: transparent; border: 1px solid #444; color: #888; padding: 0.8rem 2rem; border-radius: 30px; cursor: pointer; }
        .hearts { position: absolute; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }
        .heart { position: absolute; font-size: 2rem; animation: float 3s ease-in infinite; opacity: 0; }
        @keyframes float { 0% { opacity: 1; transform: translateY(100vh) scale(0); } 50% { opacity: 1; } 100% { opacity: 0; transform: translateY(-100vh) scale(1); } }
        
        @keyframes heartBurst { 0% { transform: scale(0); opacity: 1; } 50% { transform: scale(1.3); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
        .heart-burst { position: fixed; font-size: 4rem; pointer-events: none; z-index: 9999; animation: heartBurst 0.6s ease-out forwards; }
        
        @keyframes tapFlash { 0% { opacity: 0; } 50% { opacity: 0.3; } 100% { opacity: 0; } }
        .tap-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; pointer-events: none; z-index: 9999; animation: tapFlash 0.15s ease-out; }
        
        .pull-refresh { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); color: #888; font-size: 0.8rem; transition: top 0.2s ease; }
        .pull-refresh.visible { top: 10px; }
        
        /* NO MATCH MESSAGE */
        .no-match-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a2e; padding: 2rem 3rem; border-radius: 20px; text-align: center; z-index: 1500; display: none; border: 1px solid #444; }
        .no-match-msg h3 { color: #888; margin-bottom: 0.5rem; }
        .no-match-msg p { color: #666; font-size: 0.9rem; }
        
        /* GALLERY */
        .gallery { padding: 1rem; flex: 1; }
        .gallery h2 { margin-bottom: 1.5rem; font-size: 1.2rem; font-weight: 700; color: #ffffff; padding-left: 0.5rem; border-left: 3px solid #e91e63; }
        .girls-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
        .girl-card { background: #12121a; border-radius: 20px; overflow: hidden; cursor: pointer; transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.2s ease; position: relative; border: 1px solid rgba(255, 255, 255, 0.05); will-change: transform; }
        .girl-card:hover { transform: translate3d(0, -5px, 0); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5); }
        .girl-card:active { transform: scale(0.97); }
        .girl-card-img { height: 240px; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 50%, rgba(10,10,12,0.9) 100%); position: relative; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 700; color: rgba(233, 30, 99, 0.3); }
        .girl-card-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 1rem; background: linear-gradient(to top, #12121a, transparent); }
        .girl-card-name { font-size: 1rem; font-weight: 700; color: #ffffff; }
        .girl-card-tagline { color: #888888; font-size: 0.75rem; margin-top: 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* MATCHES LIST */
        .matches-container { padding: 1rem; padding-bottom: 80px; }
        .matches-count { font-size: 0.75rem; color: #e91e63; background: rgba(233,30,99,0.2); padding: 0.25rem 0.5rem; border-radius: 10px; }
        .matches-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .match-item { display: flex; align-items: center; gap: 0.75rem; background: #12121a; border-radius: 15px; padding: 0.75rem; cursor: pointer; transition: background 0.2s; border: 1px solid rgba(255,255,255,0.05); }
        .match-item:active { background: #1a1a2e; }
        .match-item-avatar { width: 60px; height: 60px; border-radius: 50%; background: #1a1a2e; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; color: rgba(233,30,99,0.4); overflow: hidden; flex-shrink: 0; }
        .match-item-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .match-item-info { flex: 1; min-width: 0; }
        .match-item-name { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
        .match-item-online { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; }
        .match-item-preview { color: #888; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0.2rem; }
        .match-item-time { color: #666; font-size: 0.7rem; margin-top: 0.2rem; }
        .match-item-actions { display: flex; gap: 0.5rem; }
        .match-action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: transform 0.15s; }
        .match-action-btn:active { transform: scale(0.9); }
        .match-action-chat { background: #e91e63; color: white; }
        .match-action-gallery { background: rgba(233,30,99,0.2); color: #e91e63; }
        .badge-new { position: absolute; top: 10px; right: 10px; background: #e91e63; color: white; padding: 4px 8px; border-radius: 10px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; box-shadow: 0 2px 5px rgba(233, 30, 99, 0.4); z-index: 5; }
        
        /* PROFILE */
        .profile { max-width: 500px; margin: 0 auto; width: 100%; flex: 1; }
        .back-btn { color: #ffffff; font-size: 1.5rem; cursor: pointer; padding: 1rem; display: inline-block; transition: color 0.2s; }
        .back-btn:hover { color: #e91e63; }
        .profile-img { width: 100%; aspect-ratio: 3/4; min-height: 300px; background: #12121a; display: flex; align-items: center; justify-content: center; font-size: 8rem; font-weight: 800; color: rgba(233, 30, 99, 0.1); position: relative; overflow: hidden; }
        .profile-img::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 150px; background: linear-gradient(to top, #0a0a0c, transparent); }
        .profile-content { padding: 1.5rem; margin-top: -2rem; position: relative; z-index: 10; }
        .profile h1 { font-size: 2rem; font-weight: 800; margin-bottom: 0.2rem; }
        .profile-tagline { color: #e91e63; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.5rem; }
        .profile-stats { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .stat-item { background: #12121a; padding: 0.75rem 1.25rem; border-radius: 15px; border: 1px solid rgba(233, 30, 99, 0.2); flex: 1; text-align: center; }
        .stat-label { font-size: 0.7rem; color: #888888; text-transform: uppercase; margin-bottom: 0.3rem; }
        .stat-value { font-size: 1.1rem; font-weight: 700; color: #e91e63; }
        .profile-bio { color: #888888; line-height: 1.7; font-size: 0.95rem; margin-bottom: 2rem; }
        .profile-actions { display: flex; flex-direction: column; gap: 1rem; }
        .btn-premium { width: 100%; padding: 1.1rem; border: none; border-radius: 15px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.15s ease, box-shadow 0.15s ease; text-align: center; text-decoration: none; will-change: transform; }
        .btn-chat { background: #e91e63; color: #ffffff; box-shadow: 0 5px 15px rgba(233, 30, 99, 0.3); }
        .btn-photo { background: #12121a; color: #ffffff; border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-premium:active { transform: scale(0.96); }
        
        /* CHAT */
        .chat-page { display: none; height: 100vh; overflow: hidden; }
        .chat-header { display: flex; align-items: center; padding: 1rem; background: rgba(10, 10, 12, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #1a1a1f; position: sticky; top: 0; z-index: 100; }
        .chat-avatar-circle { width: 42px; height: 42px; border-radius: 50%; background: #12121a; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 800; color: #e91e63; margin-right: 0.75rem; border: 1px solid rgba(233, 30, 99, 0.3); }
        .chat-info { flex: 1; }
        .chat-name { font-weight: 700; font-size: 1.1rem; }
        .chat-status { font-size: 0.7rem; color: #888888; display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #22c55e; }
        
        .messages { flex: 1; overflow-y: auto; padding: 1.5rem 1rem; display: flex; flex-direction: column; gap: 1.2rem; scroll-behavior: smooth; }
        .msg { max-width: 80%; display: flex; flex-direction: column; }
        .msg.user { align-self: flex-end; }
        .msg.her { align-self: flex-start; }
        .msg-bubble { padding: 0.9rem 1.1rem; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; position: relative; animation: msgAppear 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .msg-bubble.sending { opacity: 0.7; }
        .msg-bubble.sent { opacity: 1; transition: opacity 0.2s ease; }
        .msg.her .msg-bubble { background: #12121a; border-bottom-left-radius: 4px; color: #ffffff; }
        .msg.user .msg-bubble { background: #e91e63; border-bottom-right-radius: 4px; color: #ffffff; }
        .msg-meta { font-size: 0.65rem; color: #555555; margin-top: 0.3rem; display: flex; align-items: center; gap: 4px; }
        .msg.user .msg-meta { align-self: flex-end; }
        .read-receipt { color: #e91e63; font-weight: 800; }
        
        .msg-img { max-width: 280px; border-radius: 18px; overflow: hidden; margin-top: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: opacity 0.2s; }
        .msg-img img { width: 100%; display: block; }
        .msg-img:active { opacity: 0.8; }
        
        .typing-indicator { font-size: 0.75rem; color: #e91e63; margin-bottom: 0.5rem; font-style: italic; display: none; }
        
        .input-area { padding: 1.2rem 1rem; background: #0a0a0c; border-top: 1px solid #1a1a1f; padding-bottom: calc(1.2rem + env(safe-area-inset-bottom)); }
        .input-row { display: flex; gap: 0.75rem; align-items: center; }
        .chat-input { flex: 1; padding: 1rem 1.5rem; background: #12121a; border: 1px solid #1a1a1f; border-radius: 30px; color: #ffffff; font-size: 1rem; outline: none; transition: border-color 0.2s; }
        .chat-input:focus { border-color: #e91e63; }
        .send-btn { width: 50px; height: 50px; border-radius: 50%; background: #e91e63; border: none; color: #ffffff; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.15s ease; will-change: transform; }
        .send-btn:active { transform: scale(0.85); box-shadow: 0 2px 5px rgba(233, 30, 99, 0.2); }
        .send-btn:disabled { opacity: 0.5; cursor: default; }
        
        .empty-chat { text-align: center; color: #444444; padding: 4rem 1rem; font-size: 0.9rem; letter-spacing: 1px; }

        /* Fullscreen Overlay */
        #img-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 1rem; flex-direction: column; }
        #img-overlay img { max-width: 100%; max-height: 85%; border-radius: 10px; object-fit: contain; }
        .overlay-nav { display: flex; gap: 2rem; margin-top: 1rem; }
        .overlay-nav button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.8rem 1.5rem; border-radius: 25px; font-size: 1rem; cursor: pointer; }
        .overlay-counter { color: #888; font-size: 0.8rem; margin-top: 0.5rem; }
        
        /* Profile Photo Gallery */
        .profile-gallery { margin: 1rem 0; }
        .profile-gallery h3 { font-size: 0.9rem; color: #888; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        .photo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .photo-grid-item { aspect-ratio: 3/4; background: #12121a; border-radius: 12px; overflow: hidden; cursor: pointer; position: relative; border: 1px solid rgba(255,255,255,0.05); min-height: 120px; }
        .photo-grid-item.secret-unlocked { grid-column: 1 / -1; aspect-ratio: 16/9; max-height: 180px; }
        .photo-grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .photo-grid-item:hover { opacity: 0.9; }
        .photo-locked { display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a2e, #16213e); cursor: not-allowed; position: relative; overflow: hidden; }
        .photo-locked::before { content: ''; position: absolute; inset: 0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="35" r="20" fill="%23e91e6333"/><ellipse cx="50" cy="75" rx="30" ry="25" fill="%23e91e6322"/></svg>') center/cover; filter: blur(20px); opacity: 0.5; }
        .photo-locked .lock-icon { font-size: 2rem; margin-bottom: 0.5rem; z-index: 1; }
        .photo-locked span { color: #888; font-size: 0.75rem; text-align: center; z-index: 1; }
        .secret-unlocked { position: relative; }
        .secret-unlocked img { width: 100%; height: 100%; object-fit: cover; border: 2px solid #e91e63; }
        .secret-unlocked .unlock-badge { position: absolute; top: 5px; right: 5px; background: linear-gradient(135deg, #e91e63, #ff6b6b); padding: 4px 8px; border-radius: 10px; font-size: 0.7rem; color: white; font-weight: 600; }
        .photo-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #666; }
        .photo-loading .spinner { width: 30px; height: 30px; border: 3px solid #333; border-top-color: #e91e63; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 0.5rem; }
        .photo-loading span { font-size: 0.7rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Video Call Button */
        .btn-video { background: #1a1a2e; color: #888; border: 1px solid #333; margin-top: 0.5rem; }
        .btn-video:active { transform: none; }
        
        /* Toast Notification */
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1a1a2e; color: white; padding: 1rem 2rem; border-radius: 30px; z-index: 2000; display: none; border: 1px solid #e91e63; font-size: 0.9rem; }
        
        /* Stories */
        #storyOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; flex-direction: column; }
        .story-progress { display: flex; gap: 4px; padding: 10px 15px; }
        .story-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; }
        .story-bar-fill { height: 100%; background: white; width: 0%; transition: width 0.1s linear; }
        .story-bar.done .story-bar-fill { width: 100%; }
        .story-content { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .story-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .story-text { position: absolute; bottom: 80px; left: 0; right: 0; text-align: center; padding: 1rem; }
        .story-text span { background: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1rem; border-radius: 10px; font-size: 1rem; }
        .story-close { position: absolute; top: 20px; right: 15px; background: none; border: none; color: white; font-size: 2rem; cursor: pointer; z-index: 10; }
        .story-nav { position: absolute; top: 0; bottom: 0; width: 30%; cursor: pointer; }
        .story-nav-left { left: 0; }
        .story-nav-right { right: 0; }
        .btn-stories { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        
        /* STORIES SECTION - Instagram Style */
        .stories-section { padding: 0.75rem 0; border-bottom: 1px solid #1a1a1f; }
        .stories-scroll { display: flex; gap: 0.75rem; padding: 0 1rem; overflow-x: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .stories-scroll::-webkit-scrollbar { display: none; }
        .story-circle { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; cursor: pointer; flex-shrink: 0; }
        .story-avatar { width: 60px; height: 60px; border-radius: 50%; padding: 2px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        .story-avatar.no-story { background: #333; }
        .story-avatar-inner { width: 100%; height: 100%; border-radius: 50%; background: #12121a; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; color: #e91e63; overflow: hidden; border: 2px solid #0a0a0c; }
        .story-avatar-inner img { width: 100%; height: 100%; object-fit: cover; }
        .story-username { font-size: 0.65rem; color: #aaa; max-width: 64px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
        
        /* CAMGIRLS PAGE */
        .camgirls-container { padding: 1rem; }
        .camgirls-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .camgirl-card { position: relative; background: #12121a; border-radius: 15px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .camgirl-card:active { transform: scale(0.97); }
        .camgirl-card-img { aspect-ratio: 3/4; background: linear-gradient(135deg, #1a1a2e, #0d0d12); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: rgba(233,30,99,0.3); }
        .camgirl-card-img img { width: 100%; height: 100%; object-fit: cover; }
        .camgirl-live-badge { position: absolute; top: 10px; left: 10px; background: #ff0000; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .camgirl-viewers { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; }
        .camgirl-card-info { padding: 0.75rem; }
        .camgirl-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 0.2rem; }
        .camgirl-tagline { color: #888; font-size: 0.75rem; }
        
        /* CAMGIRL MODAL */
        .camgirl-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .camgirl-modal-content { width: 100%; max-width: 500px; height: 100%; display: flex; flex-direction: column; background: #0a0a0c; }
        .camgirl-modal-header { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #1a1a1f; }
        .camgirl-close { color: white; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; }
        .live-indicator { background: #ff0000; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; animation: pulse 1.5s infinite; margin-right: auto; }
        .camgirl-video { aspect-ratio: 16/9; background: #12121a; display: flex; align-items: center; justify-content: center; }
        .camgirl-video img { width: 100%; height: 100%; object-fit: cover; }
        .camgirl-info { padding: 1rem; text-align: center; }
        .camgirl-info h3 { font-size: 1.2rem; margin-bottom: 0.3rem; }
        .camgirl-info p { color: #888; font-size: 0.85rem; }
        .tip-menu { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem 1rem; justify-content: center; }
        .tip-btn { background: linear-gradient(135deg, #e91e63, #9c27b0); color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; cursor: pointer; transition: transform 0.2s; }
        .tip-btn:active { transform: scale(0.95); }
        .tip-btn span { font-weight: 700; }
        .camgirl-chat { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        .cam-msg { background: rgba(255,255,255,0.05); padding: 0.5rem 0.75rem; border-radius: 10px; font-size: 0.8rem; }
        .cam-msg.tip { background: rgba(233,30,99,0.2); border: 1px solid rgba(233,30,99,0.3); }
        .cam-msg .user { color: #e91e63; font-weight: 600; }
        
        /* CHARACTER CREATION */
        .btn-create-char { background: linear-gradient(135deg, #9c27b0, #673ab7); color: white; width: 100%; padding: 1rem; border: none; border-radius: 15px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-create-char:active { transform: scale(0.98); }
        .character-creator-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; overflow-y: auto; padding: 1rem; }
        .creator-content { width: 100%; max-width: 400px; background: #12121a; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        .creator-header { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #1a1a1f; position: sticky; top: 0; background: #12121a; z-index: 10; }
        .creator-header h2 { flex: 1; font-size: 1.1rem; margin: 0; }
        .creator-close { font-size: 1.5rem; cursor: pointer; color: #888; }
        .creator-form { padding: 1rem; }
        .creator-field { margin-bottom: 1rem; }
        .creator-field label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 0.4rem; }
        .creator-input, .creator-select { width: 100%; padding: 0.75rem; background: #0a0a0c; border: 1px solid #333; border-radius: 10px; color: white; font-size: 0.9rem; }
        .creator-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; }
        .creator-input:focus, .creator-select:focus { outline: none; border-color: #e91e63; }
        
        /* GAMES BUTTON IN CHAT */
        .games-btn { background: linear-gradient(135deg, #ff6b6b, #e91e63); color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }
        .games-menu { background: #12121a; border-radius: 15px; padding: 0.5rem; margin: 0.5rem 0; }
        .game-item { padding: 0.75rem 1rem; border-radius: 10px; cursor: pointer; transition: background 0.2s; }
        .game-item:active { background: rgba(233,30,99,0.2); }
        .game-name { font-weight: 600; font-size: 0.9rem; }
        .game-desc { color: #888; font-size: 0.75rem; margin-top: 0.2rem; }
        
        /* BOTTOM NAVIGATION */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #0a0a0c; border-top: 1px solid #1a1a1f; display: flex; justify-content: space-around; padding: 0.5rem 0; padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); z-index: 500; backdrop-filter: blur(20px); }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 0.5rem 1rem; cursor: pointer; transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94), color 0.15s ease; border: none; background: none; will-change: transform; }
        .nav-item:active { transform: scale(0.85); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 0.2rem; transition: color 0.15s ease, transform 0.15s ease; }
        .nav-item.active .nav-icon { transform: scale(1.1); }
        .nav-label { font-size: 0.65rem; color: #666; transition: color 0.15s ease; }
        .nav-item.active .nav-icon { color: #e91e63; }
        .nav-item.active .nav-label { color: #e91e63; }
        .nav-item:not(.active) .nav-icon { color: #666; }
        .nav-badge { position: absolute; top: 0; right: 0.5rem; background: #e91e63; color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 10px; font-weight: 700; }
        .page-with-nav { padding-bottom: 80px; }
        
        /* MESSAGES PAGE */
        .messages-list { padding: 1rem; }
        .message-item { display: flex; align-items: center; padding: 1rem; background: #12121a; border-radius: 15px; margin-bottom: 0.75rem; cursor: pointer; transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.15s ease; border: 1px solid rgba(255,255,255,0.03); will-change: transform; }
        .message-item:active { transform: scale(0.97); background: #1a1a2e; }
        .message-avatar { width: 55px; height: 55px; border-radius: 50%; background: #1a1a2e; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; color: #e91e63; margin-right: 1rem; border: 2px solid rgba(233,30,99,0.3); flex-shrink: 0; }
        .message-info { flex: 1; min-width: 0; }
        .message-name { font-weight: 700; font-size: 1rem; margin-bottom: 0.2rem; }
        .message-preview { color: #888; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .message-time { color: #666; font-size: 0.7rem; text-align: right; flex-shrink: 0; }
        .message-unread { width: 10px; height: 10px; background: #e91e63; border-radius: 50%; margin-left: 0.5rem; flex-shrink: 0; }
        .no-messages { text-align: center; color: #666; padding: 4rem 2rem; }
        
        /* RECEIVED PHOTOS GALLERY */
        .photos-gallery { padding: 1rem; }
        .photos-gallery h2 { margin-bottom: 1.5rem; font-size: 1.2rem; font-weight: 700; color: #ffffff; padding-left: 0.5rem; border-left: 3px solid #e91e63; }
        .gallery-section { margin-bottom: 2rem; }
        .gallery-section-title { font-size: 0.9rem; color: #888; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .gallery-section-title::before { content: ''; width: 30px; height: 30px; border-radius: 50%; background: #12121a; display: flex; align-items: center; justify-content: center; }
        .photos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .gallery-photo { aspect-ratio: 1; background: #12121a; border-radius: 4px; overflow: hidden; cursor: pointer; transition: opacity 0.2s; }
        .gallery-photo img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-photo:active { opacity: 0.7; }
        .no-photos { text-align: center; color: #666; padding: 4rem 2rem; }
        
        /* USER PROFILE/SETTINGS PAGE */
        .settings-page { padding: 1.5rem; }
        .settings-header { text-align: center; margin-bottom: 2rem; }
        .settings-avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #e91e63, #9c27b0); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 800; color: white; }
        .settings-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.3rem; }
        .settings-age { color: #888; font-size: 0.9rem; }
        .settings-stats { display: flex; justify-content: center; gap: 2rem; margin: 1.5rem 0; padding: 1rem; background: #12121a; border-radius: 15px; }
        .settings-stat { text-align: center; }
        .settings-stat-value { font-size: 1.5rem; font-weight: 700; color: #e91e63; }
        .settings-stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-top: 0.2rem; }
        .settings-section { margin-top: 1.5rem; }
        .settings-section-title { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.75rem; padding-left: 0.5rem; }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #12121a; border-radius: 12px; margin-bottom: 0.5rem; cursor: pointer; transition: background 0.2s; }
        .settings-item:active { background: #1a1a2e; }
        .settings-item-left { display: flex; align-items: center; gap: 0.75rem; }
        .settings-item-icon { font-size: 1.2rem; }
        .settings-item-text { font-size: 0.95rem; }
        .settings-item-arrow { color: #666; }
        .btn-logout { width: 100%; padding: 1rem; background: transparent; border: 1px solid #ff4444; color: #ff4444; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 2rem; transition: all 0.2s; }
        .btn-logout:active { background: #ff4444; color: white; }
        .btn-reset { width: 100%; padding: 1rem; background: transparent; border: 1px solid #666; color: #666; border-radius: 12px; font-size: 0.9rem; cursor: pointer; margin-top: 0.5rem; }
        
        /* Loading Animation */
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .loading-shimmer { background: linear-gradient(90deg, #12121a 25%, #1a1a2e 50%, #12121a 75%); background-size: 200% 100%; animation: shimmer 1.2s ease-in-out infinite; }
        
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        .typing-indicator { display: flex; gap: 4px; padding: 0.5rem 1rem; align-items: center; }
        .typing-dots { display: inline-flex; gap: 3px; align-items: center; }
        .typing-dot { width: 6px; height: 6px; background: #e91e63; border-radius: 50%; animation: typing 1.2s ease-in-out infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        .photo-spinner { width: 40px; height: 40px; border: 3px solid rgba(233,30,99,0.2); border-top-color: #e91e63; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 1rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .swipe-card { animation: scaleIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .match-overlay-content { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        
        /* PWA INSTALL BANNER */
        .install-banner { position: fixed; bottom: 80px; left: 1rem; right: 1rem; background: linear-gradient(135deg, #e91e63, #9c27b0); padding: 1rem 1.5rem; border-radius: 15px; display: none; align-items: center; justify-content: space-between; z-index: 1000; box-shadow: 0 5px 20px rgba(233,30,99,0.4); animation: slideUp 0.3s ease; }
        .install-banner-text { color: white; font-weight: 600; }
        .install-banner-btn { background: white; color: #e91e63; border: none; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; cursor: pointer; }
        .install-banner-close { background: none; border: none; color: rgba(255,255,255,0.7); font-size: 1.2rem; cursor: pointer; margin-left: 0.5rem; }
        
        /* FILTER BUTTONS */
        .filter-section { padding: 0.3rem 0.5rem; background: #0a0a0c; border-bottom: 1px solid #1a1a1f; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .filter-row { display: flex; gap: 0.3rem; margin-bottom: 0.3rem; flex-wrap: nowrap; }
        .filter-btn { padding: 0.3rem 0.6rem; background: #12121a; border: 1px solid #1a1a1f; border-radius: 15px; color: #888; font-size: 0.7rem; cursor: pointer; flex-shrink: 0; transition: all 0.15s ease; }
        .filter-btn.active { background: #e91e63; color: white; border-color: #e91e63; }
        .filter-btn:active { transform: scale(0.95); }
        
        /* NOTIFICATION BADGE */
        .nav-badge { position: absolute; top: 2px; right: 50%; transform: translateX(100%); background: #e91e63; color: white; font-size: 0.6rem; min-width: 16px; height: 16px; padding: 0 4px; border-radius: 10px; font-weight: 700; display: none; align-items: center; justify-content: center; }
        .nav-badge.show { display: flex; }
        
        /* ICEBREAKERS */
        .icebreakers { display: flex; gap: 0.5rem; padding: 0.5rem 1rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .icebreaker-btn { flex-shrink: 0; padding: 0.5rem 1rem; background: #12121a; border: 1px solid rgba(233,30,99,0.3); border-radius: 20px; color: #e91e63; font-size: 0.8rem; cursor: pointer; transition: all 0.15s ease; }
        .icebreaker-btn:active { transform: scale(0.95); background: #e91e63; color: white; }
        
        /* CHAT MENU */
        .chat-menu-btn { margin-left: auto; background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }
        .chat-menu { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2500; display: none; align-items: flex-end; justify-content: center; }
        .chat-menu.show { display: flex; }
        .chat-menu-content { background: #12121a; width: 100%; max-width: 400px; border-radius: 20px 20px 0 0; padding: 1rem; animation: slideUp 0.2s ease; }
        .chat-menu-option { padding: 1rem; text-align: center; font-size: 1rem; cursor: pointer; border-radius: 10px; margin-bottom: 0.5rem; transition: background 0.15s ease; }
        .chat-menu-option:active { background: #1a1a2e; }
        .chat-menu-option.danger { color: #ff4444; }
        .chat-menu-cancel { padding: 1rem; text-align: center; background: #1a1a2e; border-radius: 10px; color: #888; cursor: pointer; margin-top: 0.5rem; }
        
        /* CONFIRMATION POPUP */
        .confirm-popup { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 2rem; }
        .confirm-popup.show { display: flex; }
        .confirm-content { background: #12121a; border-radius: 20px; padding: 2rem; text-align: center; max-width: 300px; animation: scaleIn 0.2s ease; }
        .confirm-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .confirm-text { color: #888; font-size: 0.9rem; margin-bottom: 1.5rem; }
        .confirm-buttons { display: flex; gap: 1rem; }
        .confirm-btn { flex: 1; padding: 0.8rem; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .confirm-btn-cancel { background: #1a1a2e; color: #888; }
        .confirm-btn-confirm { background: #ff4444; color: white; }
        
        /* PREMIUM POPUP */
        .premium-popup { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 2rem; }
        .premium-popup.show { display: flex; }
        .premium-content { background: linear-gradient(135deg, #1a1a2e, #12121a); border: 2px solid #e91e63; border-radius: 25px; padding: 2rem; text-align: center; max-width: 320px; animation: bounceIn 0.4s ease; }
        .premium-crown { font-size: 4rem; margin-bottom: 1rem; }
        .premium-title { font-size: 1.5rem; font-weight: 800; color: #e91e63; margin-bottom: 0.5rem; }
        .premium-features { text-align: left; margin: 1.5rem 0; }
        .premium-feature { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; color: #ccc; font-size: 0.9rem; }
        .premium-feature::before { content: 'âœ“'; color: #e91e63; font-weight: 700; }
        .premium-price { font-size: 2rem; font-weight: 800; color: white; margin: 1rem 0; }
        .premium-price span { font-size: 1rem; color: #888; }
        .premium-btn { width: 100%; padding: 1rem; background: #e91e63; border: none; border-radius: 15px; color: white; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 0.5rem; }
        .premium-close { margin-top: 1rem; background: none; border: none; color: #666; cursor: pointer; }
        
        /* SUPER LIKE BUTTON */
        .swipe-btn-super { background: #00bcd4; color: white; width: 55px; height: 55px; font-size: 1.5rem; }
        .swipe-btn-boost { background: #9c27b0; color: white; width: 55px; height: 55px; font-size: 1.3rem; }
        
        /* EDIT PROFILE */
        .edit-profile-section { margin-bottom: 1.5rem; }
        .edit-label { font-size: 0.8rem; color: #888; margin-bottom: 0.5rem; text-transform: uppercase; }
        .edit-input { width: 100%; padding: 1rem; background: #12121a; border: 1px solid #1a1a1f; border-radius: 12px; color: white; font-size: 1rem; outline: none; margin-bottom: 1rem; }
        .edit-input:focus { border-color: #e91e63; }
        .edit-textarea { min-height: 100px; resize: vertical; }
        .age-slider-container { padding: 1rem 0; }
        .age-slider { width: 100%; -webkit-appearance: none; height: 4px; background: #1a1a1f; border-radius: 2px; outline: none; }
        .age-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #e91e63; border-radius: 50%; cursor: pointer; }
        .age-range-display { display: flex; justify-content: space-between; color: #888; font-size: 0.8rem; margin-top: 0.5rem; }
        
        /* THEME TOGGLE */
        .theme-toggle { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #12121a; border-radius: 12px; margin-bottom: 0.5rem; }
        .toggle-switch { width: 50px; height: 26px; background: #1a1a1f; border-radius: 13px; position: relative; cursor: pointer; transition: background 0.2s; }
        .toggle-switch.active { background: #e91e63; }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.2s; }
        .toggle-switch.active::after { transform: translateX(24px); }
        
        /* LIGHT THEME */
        body.light-theme { background: #f5f5f5; color: #1a1a1a; }
        body.light-theme .page { background: #f5f5f5; }
        body.light-theme .header { background: rgba(255,255,255,0.9); border-color: #e0e0e0; }
        body.light-theme .logo { color: #e91e63; }
        body.light-theme .swipe-card { background: white; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        body.light-theme .swipe-card-img { background: #f0f0f5; }
        body.light-theme .girl-card { background: white; border-color: #e0e0e0; }
        body.light-theme .bottom-nav { background: white; border-color: #e0e0e0; }
        body.light-theme .nav-item:not(.active) .nav-icon { color: #666; }
        body.light-theme .message-item { background: white; border-color: #e0e0e0; }
        body.light-theme .settings-page { background: #f5f5f5; }
        body.light-theme .settings-stats { background: white; }
        body.light-theme .settings-item { background: white; }
        body.light-theme .chat-input { background: white; border-color: #e0e0e0; color: #1a1a1a; }
        body.light-theme .msg-received { background: #e0e0e0; color: #1a1a1a; }
        body.light-theme .chat-header { background: rgba(255,255,255,0.9); border-color: #e0e0e0; }
        body.light-theme .filter-btn { background: white; border-color: #e0e0e0; color: #666; }
        body.light-theme .icebreaker-btn { background: white; }
        body.light-theme .edit-input { background: white; border-color: #e0e0e0; color: #1a1a1a; }
        body.light-theme .login-input { background: white; border-color: #e0e0e0; color: #1a1a1a; }
    </style>
</head>
<body>

<div class="page login-page active" id="pageLogin">
    <div class="login-box">
        <div class="login-logo">DREAM AI GIRL</div>
        <div class="login-subtitle">Trouve ta partenaire virtuelle</div>
        
        <div class="auth-tabs">
            <button class="auth-tab active" id="tabLogin" onclick="showAuthTab('login')">Connexion</button>
            <button class="auth-tab" id="tabRegister" onclick="showAuthTab('register')">Inscription</button>
        </div>
        
        <form class="login-form" id="formLogin" onsubmit="event.preventDefault(); doLogin();">
            <input type="email" class="login-input" id="loginEmail" placeholder="Email" required autocomplete="email">
            <input type="password" class="login-input" id="loginPassword" placeholder="Mot de passe" required autocomplete="current-password">
            <button type="submit" class="login-btn">Se connecter</button>
            <div class="auth-error" id="loginError"></div>
            <div class="forgot-password" onclick="showForgotPassword()">Mot de passe oublie?</div>
        </form>
        
        <form class="login-form" id="formRegister" style="display:none;" onsubmit="event.preventDefault(); doRegister();">
            <input type="text" class="login-input" id="regUsername" placeholder="Ton prenom" required autocomplete="given-name">
            <input type="email" class="login-input" id="regEmail" placeholder="Ton email" required autocomplete="email">
            <input type="password" class="login-input" id="regPassword" placeholder="Mot de passe (min 6 caracteres)" minlength="6" required autocomplete="new-password">
            <input type="number" class="login-input" id="regAge" placeholder="Ton age (18+ requis)" min="18" max="99" required>
            <div class="photo-upload-section">
                <label class="photo-upload-label" for="regPhoto">
                    <div class="photo-preview" id="photoPreview">+</div>
                    <span>Photo de profil (optionnel)</span>
                </label>
                <input type="file" id="regPhoto" accept="image/*" style="display:none;" onchange="previewPhoto(this)">
            </div>
            <button type="submit" class="login-btn">Creer mon compte</button>
            <div class="auth-error" id="registerError"></div>
        </form>
    </div>
</div>

<div class="page page-with-nav" id="pageDiscover">
    <div class="header">
        <div class="header-row">
            <div class="logo">DREAM AI GIRL</div>
            <div class="user-name" id="headerUserName"></div>
        </div>
    </div>
    
    <div class="stories-section" id="storiesSection">
        <div class="stories-scroll" id="storiesScroll"></div>
    </div>
    
    <div class="filter-section">
        <div class="filter-row">
            <button class="filter-btn active" onclick="setAgeFilter('all')" id="filterAgeAll">Tous</button>
            <button class="filter-btn" onclick="setAgeFilter('18-25')" id="filterAge1825">18-25</button>
            <button class="filter-btn" onclick="setAgeFilter('25-35')" id="filterAge2535">25-35</button>
            <button class="filter-btn" onclick="setAgeFilter('35-45')" id="filterAge3545">35-45</button>
            <button class="filter-btn" onclick="setAgeFilter('45+')" id="filterAge45">45+</button>
        </div>
        <div class="filter-row">
            <button class="filter-btn active" onclick="setRegionFilter('all')" id="filterRegionAll">Tous</button>
            <button class="filter-btn" onclick="setRegionFilter('france')" id="filterFrance">France</button>
            <button class="filter-btn" onclick="setRegionFilter('usa')" id="filterUSA">USA</button>
            <button class="filter-btn" onclick="setRegionFilter('bresil')" id="filterBresil">Bresil</button>
            <button class="filter-btn" onclick="setRegionFilter('japon')" id="filterJapon">Japon</button>
            <button class="filter-btn" onclick="setRegionFilter('chine')" id="filterChine">Chine</button>
            <button class="filter-btn" onclick="setRegionFilter('thailande')" id="filterThailande">Thailande</button>
            <button class="filter-btn" onclick="setRegionFilter('indonesie')" id="filterIndonesie">Indonesie</button>
            <button class="filter-btn" onclick="setRegionFilter('russie')" id="filterRussie">Russie</button>
            <button class="filter-btn" onclick="setRegionFilter('moyen_orient')" id="filterMoyenOrient">Moyen-Orient</button>
            <button class="filter-btn" onclick="setRegionFilter('maghreb')" id="filterMaghreb">Maghreb</button>
            <button class="filter-btn" onclick="setRegionFilter('afrique')" id="filterAfrique">Afrique</button>
            <button class="filter-btn" onclick="setRegionFilter('europe')" id="filterEurope">Europe</button>
            <button class="filter-btn" onclick="setRegionFilter('amerique_latine')" id="filterAmeriqueLat">Amerique Lat.</button>
            <button class="filter-btn" onclick="setRegionFilter('asie')" id="filterAsie">Asie</button>
        </div>
    </div>
    
    <div class="swipe-container" id="swipeContainer">
        <div class="swipe-card next-card" id="swipeCardNext">
            <div class="swipe-card-img" id="swipeCardImgNext"></div>
            <div class="swipe-card-info">
                <div class="swipe-card-name" id="swipeCardNameNext"></div>
                <div class="swipe-card-location" id="swipeCardLocationNext"></div>
                <div class="swipe-card-bio" id="swipeCardBioNext"></div>
            </div>
        </div>
        <div class="swipe-card current-card" id="swipeCard" onclick="handleDoubleTap(event, doubleTapLike)">
            <div class="swipe-overlay like" id="swipeLikeOverlay">LIKE</div>
            <div class="swipe-overlay nope" id="swipeNopeOverlay">NOPE</div>
            <div class="swipe-card-img" id="swipeCardImg"></div>
            <div class="swipe-card-info">
                <div class="swipe-card-name" id="swipeCardName"></div>
                <div class="swipe-card-location" id="swipeCardLocation"></div>
                <div class="swipe-card-bio" id="swipeCardBio"></div>
            </div>
        </div>
        <div class="no-more-cards" id="noMoreCards" style="display:none;">
            <p>Plus de profils pour le moment</p>
            <p style="color:#666;font-size:0.8rem;margin-top:0.5rem;">Reviens plus tard</p>
        </div>
    </div>
    <div class="swipe-buttons" id="swipeButtons">
        <button class="swipe-btn swipe-btn-pass" onclick="swipeLeft()">X</button>
        <button class="swipe-btn swipe-btn-super" onclick="showPremiumPopup()">â˜…</button>
        <button class="swipe-btn swipe-btn-like" onclick="swipeRight()">â™¥</button>
        <button class="swipe-btn swipe-btn-boost" onclick="showPremiumPopup()">âš¡</button>
    </div>
</div>

<div class="page page-with-nav" id="pageMessages">
    <div class="header">
        <div class="logo">Messages</div>
    </div>
    <div class="messages-list" id="messagesList"></div>
    <div class="no-messages" id="noMessagesText" style="display:none;">
        <p style="font-size:3rem;margin-bottom:1rem;">ðŸ’¬</p>
        <p>Pas encore de conversations</p>
        <p style="font-size:0.85rem;margin-top:0.5rem;color:#888;">Match avec quelqu'un pour commencer</p>
    </div>
</div>

<div class="page page-with-nav" id="pageMatches">
    <div class="header">
        <div class="logo">Tes Matchs</div>
        <span class="matches-count" id="matchesCount"></span>
    </div>
    <div class="matches-container">
        <div class="matches-list" id="matchesList"></div>
        <div id="noMatches" style="text-align:center;color:#666;padding:3rem;display:none;">
            <p style="font-size:3rem;margin-bottom:1rem;">ðŸ’•</p>
            <p>Pas encore de matchs</p>
            <p style="font-size:0.8rem;margin-top:0.5rem;">Continue a swiper pour en trouver</p>
        </div>
    </div>
</div>

<div class="page page-with-nav" id="pageCamgirls">
    <div class="header">
        <div class="logo">Camgirls Live</div>
    </div>
    <div class="camgirls-container">
        <div class="camgirls-grid" id="camgirlsGrid"></div>
    </div>
</div>

<div class="camgirl-modal" id="camgirlModal" style="display:none;">
    <div class="camgirl-modal-content">
        <div class="camgirl-modal-header">
            <span class="camgirl-close" onclick="closeCamgirlModal()">&times;</span>
            <div class="live-indicator">LIVE</div>
            <span class="camgirl-viewers" id="camgirlViewers">0 viewers</span>
        </div>
        <div class="camgirl-video" id="camgirlVideo"></div>
        <div class="camgirl-info">
            <h3 id="camgirlName"></h3>
            <p id="camgirlTagline"></p>
        </div>
        <div class="tip-menu" id="tipMenu"></div>
        <div class="camgirl-chat" id="camgirlChat"></div>
    </div>
</div>

<div class="page page-with-nav" id="pageGallery">
    <div class="header">
        <div class="logo">Galerie</div>
    </div>
    <div class="photos-gallery" id="photosGallery"></div>
    <div class="no-photos" id="noPhotosText" style="display:none;">
        <p style="font-size:3rem;margin-bottom:1rem;">ðŸ“¸</p>
        <p>Aucune photo recue</p>
        <p style="font-size:0.85rem;margin-top:0.5rem;color:#888;">Discute avec tes matchs pour en recevoir</p>
    </div>
</div>

<div class="page page-with-nav" id="pageSettings">
    <div class="settings-page">
        <div class="settings-header">
            <div class="settings-avatar" id="settingsAvatar"></div>
            <div class="settings-name" id="settingsName"></div>
            <div class="settings-age" id="settingsAge"></div>
        </div>
        <div class="settings-stats">
            <div class="settings-stat">
                <div class="settings-stat-value" id="statsMatches">0</div>
                <div class="settings-stat-label">Matchs</div>
            </div>
            <div class="settings-stat">
                <div class="settings-stat-value" id="statsPhotos">0</div>
                <div class="settings-stat-label">Photos</div>
            </div>
            <div class="settings-stat">
                <div class="settings-stat-value" id="statsChats">0</div>
                <div class="settings-stat-label">Chats</div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Apparence</div>
            <div class="theme-toggle">
                <div class="settings-item-left">
                    <span class="settings-item-icon">ðŸŒ™</span>
                    <span class="settings-item-text">Mode Sombre</span>
                </div>
                <div class="toggle-switch active" id="themeToggle" onclick="toggleTheme()"></div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Preferences</div>
            <div class="settings-item" onclick="showPremiumPopup()">
                <div class="settings-item-left">
                    <span class="settings-item-icon">ðŸ‘‘</span>
                    <span class="settings-item-text">Dream AI Girl Premium</span>
                </div>
                <span class="settings-item-arrow">â†’</span>
            </div>
            <div class="settings-item" onclick="showPremiumPopup()">
                <div class="settings-item-left">
                    <span class="settings-item-icon">ðŸ‘€</span>
                    <span class="settings-item-text">Voir qui t'a like</span>
                </div>
                <span class="settings-item-arrow">ðŸ”’</span>
            </div>
            <div class="settings-item" onclick="showVideoToast()">
                <div class="settings-item-left">
                    <span class="settings-item-icon">ðŸ””</span>
                    <span class="settings-item-text">Notifications</span>
                </div>
                <span class="settings-item-arrow">â†’</span>
            </div>
            <div class="settings-item" onclick="showVideoToast()">
                <div class="settings-item-left">
                    <span class="settings-item-icon">ðŸ”’</span>
                    <span class="settings-item-text">Confidentialite</span>
                </div>
                <span class="settings-item-arrow">â†’</span>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Contenu</div>
            <div class="settings-item" onclick="navigateTo('gallery')">
                <div class="settings-item-left">
                    <span class="settings-item-icon">ðŸ“¸</span>
                    <span class="settings-item-text">Ma galerie privee</span>
                </div>
                <span class="settings-item-arrow">â†’</span>
            </div>
            <div class="settings-item" onclick="openCharacterCreator()">
                <div class="settings-item-left">
                    <span class="settings-item-icon">âœ¨</span>
                    <span class="settings-item-text">Creer ta fille ideale</span>
                </div>
                <span class="settings-item-arrow">â†’</span>
            </div>
        </div>
        <button class="btn-reset" onclick="resetAllData()">Reinitialiser les donnees</button>
        <button class="btn-logout" onclick="logout()">Se deconnecter</button>
    </div>
</div>

<div class="character-creator-modal" id="characterCreatorModal" style="display:none;">
    <div class="creator-content">
        <div class="creator-header">
            <span class="creator-close" onclick="closeCharacterCreator()">&times;</span>
            <h2>Creer ta fille ideale</h2>
        </div>
        <div class="creator-form" id="creatorForm">
            <div class="creator-field">
                <label>Prenom</label>
                <input type="text" id="charName" placeholder="Son prenom..." class="creator-input">
            </div>
            <div class="creator-field">
                <label>Age (18-50)</label>
                <input type="number" id="charAge" min="18" max="50" value="25" class="creator-input">
            </div>
            <div class="creator-field">
                <label>Origine</label>
                <select id="charEthnicity" class="creator-select">
                    <option value="europeenne">Europeenne</option>
                    <option value="africaine">Africaine</option>
                    <option value="asiatique">Asiatique</option>
                    <option value="latine">Latine</option>
                    <option value="arabe">Arabe</option>
                    <option value="indienne">Indienne</option>
                    <option value="metisse">Metisse</option>
                </select>
            </div>
            <div class="creator-field">
                <label>Silhouette</label>
                <select id="charBody" class="creator-select">
                    <option value="petite">Petite</option>
                    <option value="mince">Mince</option>
                    <option value="athletic">Athletique</option>
                    <option value="curvy">Curvy</option>
                    <option value="voluptueuse">Voluptueuse</option>
                    <option value="bbw">BBW</option>
                </select>
            </div>
            <div class="creator-field">
                <label>Poitrine</label>
                <select id="charBreast" class="creator-select">
                    <option value="A">Petite (A)</option>
                    <option value="B">Moyenne (B)</option>
                    <option value="C">Genereuse (C)</option>
                    <option value="D">Grande (D)</option>
                    <option value="DD">Tres grande (DD+)</option>
                </select>
            </div>
            <div class="creator-field">
                <label>Cheveux</label>
                <select id="charHair" class="creator-select">
                    <option value="blonde">Blonde</option>
                    <option value="brune">Brune</option>
                    <option value="rousse">Rousse</option>
                    <option value="noire">Noire</option>
                    <option value="chatain">Chatain</option>
                    <option value="rose">Rose</option>
                    <option value="bleue">Bleue</option>
                </select>
            </div>
            <div class="creator-field">
                <label>Personnalite</label>
                <select id="charArchetype" class="creator-select">
                    <option value="soumise">Soumise et docile</option>
                    <option value="dominante">Dominante</option>
                    <option value="nympho">Nymphomane</option>
                    <option value="timide">Timide</option>
                    <option value="exhib">Exhibitionniste</option>
                    <option value="fetichiste">Fetichiste</option>
                    <option value="romantique">Romantique</option>
                    <option value="cougar">Cougar</option>
                </select>
            </div>
            <button class="btn-create-char" onclick="createCharacter()">Creer ma fille</button>
        </div>
    </div>
</div>

<nav class="bottom-nav" id="bottomNav" style="display:none;">
    <button class="nav-item active" onclick="navigateTo('discover')" id="navDiscover">
        <span class="nav-icon">ðŸ”¥</span>
        <span class="nav-label">Decouvrir</span>
    </button>
    <button class="nav-item" onclick="navigateTo('matches')" id="navMatches" style="position:relative;">
        <span class="nav-icon">ðŸ’•</span>
        <span class="nav-label">Matchs</span>
        <span class="nav-badge" id="matchBadge" style="display:none;">0</span>
    </button>
    <button class="nav-item" onclick="navigateTo('messages')" id="navMessages" style="position:relative;">
        <span class="nav-icon">ðŸ’¬</span>
        <span class="nav-label">Messages</span>
        <span class="nav-badge" id="msgBadge">0</span>
    </button>
    <button class="nav-item" onclick="navigateTo('camgirls')" id="navCamgirls">
        <span class="nav-icon">ðŸ“¹</span>
        <span class="nav-label">Cam</span>
    </button>
    <button class="nav-item" onclick="navigateTo('settings')" id="navSettings">
        <span class="nav-icon">ðŸ‘¤</span>
        <span class="nav-label">Profil</span>
    </button>
</nav>

<div class="page" id="pageProfile">
    <div class="profile">
        <div class="back-btn" onclick="goBackFromProfile()">â†</div>
        <div class="profile-img" id="profileMainPhoto"></div>
        <div class="profile-content">
            <h1 id="profileName"></h1>
            <div class="profile-tagline" id="profileTagline"></div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-label">Affection</div>
                    <div class="stat-value" id="profileAffection">20%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Statut</div>
                    <div class="stat-value" style="color:#22c55e">Online</div>
                </div>
            </div>
            
            <div class="profile-gallery">
                <h3>Photos</h3>
                <div class="photo-grid" id="profilePhotoGrid"></div>
            </div>
            
            <div class="profile-bio" id="profileBio"></div>
            
            <div class="profile-actions">
                <button class="btn-premium btn-chat" onclick="startChat()">Envoyer un Message</button>
                <button class="btn-premium btn-photo" onclick="requestProfilePhoto()">Demander une Photo</button>
                <button class="btn-premium btn-stories" onclick="openStories()">Voir sa Story</button>
                <button class="btn-premium btn-video" onclick="showVideoToast()">Appel VidÃ©o</button>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast">BientÃ´t disponible</div>

<div class="page chat-page" id="pageChat">
    <div class="chat-header">
        <div class="back-btn" onclick="goBackFromChat()">â†</div>
        <div class="chat-avatar-circle" id="chatInitials"></div>
        <div class="chat-info">
            <div class="chat-name" id="chatName"></div>
            <div class="chat-status"><span class="status-dot"></span> Online</div>
        </div>
        <button class="chat-menu-btn" onclick="openChatMenu()">â‹®</button>
    </div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
        <div id="typing-indicator" class="typing-indicator"></div>
        <div class="icebreakers" id="icebreakers">
            <button class="icebreaker-btn" onclick="sendIcebreaker('Hey ca va?')">Hey ca va?</button>
            <button class="icebreaker-btn" onclick="sendIcebreaker('T es vraiment canon')">T es vraiment canon</button>
            <button class="icebreaker-btn" onclick="sendIcebreaker('On discute?')">On discute?</button>
        </div>
        <div class="input-row">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ã‰cris un message...">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">âž¤</button>
        </div>
    </div>
</div>

<div class="chat-menu" id="chatMenu" onclick="closeChatMenu()">
    <div class="chat-menu-content" onclick="event.stopPropagation()">
        <div class="chat-menu-option" onclick="showConfirmPopup('unmatch')">Unmatch</div>
        <div class="chat-menu-option danger" onclick="showConfirmPopup('block')">Bloquer</div>
        <div class="chat-menu-option danger" onclick="showConfirmPopup('report')">Signaler</div>
        <div class="chat-menu-cancel" onclick="closeChatMenu()">Annuler</div>
    </div>
</div>

<div class="confirm-popup" id="confirmPopup">
    <div class="confirm-content">
        <div class="confirm-title" id="confirmTitle">Confirmer</div>
        <div class="confirm-text" id="confirmText">Es-tu sur?</div>
        <div class="confirm-buttons">
            <button class="confirm-btn confirm-btn-cancel" onclick="closeConfirmPopup()">Annuler</button>
            <button class="confirm-btn confirm-btn-confirm" id="confirmBtn" onclick="confirmAction()">Confirmer</button>
        </div>
    </div>
</div>

<div class="premium-popup" id="premiumPopup">
    <div class="premium-content">
        <div class="premium-crown">ðŸ‘‘</div>
        <div class="premium-title">Dream AI Girl Premium</div>
        <div class="premium-features">
            <div class="premium-feature">Super Likes illimites</div>
            <div class="premium-feature">Voir qui t'a like</div>
            <div class="premium-feature">Boost de visibilite</div>
            <div class="premium-feature">Photos exclusives</div>
            <div class="premium-feature">Messages prioritaires</div>
        </div>
        <div class="premium-price">9.99EUR <span>/mois</span></div>
        <button class="premium-btn" onclick="closePremiumPopup()">Debloquer Premium</button>
        <button class="premium-close" onclick="closePremiumPopup()">Plus tard</button>
    </div>
</div>

<div class="install-banner" id="installBanner">
    <span class="install-banner-text">Installer l'app</span>
    <div>
        <button class="install-banner-btn" onclick="installPWA()">Installer</button>
        <button class="install-banner-close" onclick="hideInstallBanner()">Ã—</button>
    </div>
</div>

<div id="img-overlay">
    <img id="overlay-img" src="">
    <div class="overlay-counter" id="overlay-counter">1 / 4</div>
    <div class="overlay-nav">
        <button onclick="prevOverlayImg()">PrÃ©cÃ©dent</button>
        <button onclick="document.getElementById('img-overlay').style.display='none'">Fermer</button>
        <button onclick="nextOverlayImg()">Suivant</button>
    </div>
</div>

<div id="matchOverlay">
    <div class="hearts" id="hearts"></div>
    <div class="match-title">C'est un Match!</div>
    <div class="match-girl-photo" id="matchGirlPhoto"></div>
    <div class="match-girl-name" id="matchGirlName"></div>
    <div class="match-photos">
        <div class="match-photo match-photo-small" id="matchPhotoUser">?</div>
        <div class="match-heart-icon">+</div>
        <div class="match-photo match-photo-small" id="matchPhotoGirl"></div>
    </div>
    <button class="match-btn" onclick="goToMatchChat()">Envoyer un message</button>
    <button class="match-close" onclick="closeMatch()">Continuer a swiper</button>
</div>

<div class="no-match-msg" id="noMatchMsg">
    <h3>Elle n'a pas matchÃ© avec toi</h3>
    <p>Passe au profil suivant</p>
</div>

<div id="storyOverlay">
    <div class="story-progress" id="storyProgress"></div>
    <button class="story-close" onclick="closeStories()">X</button>
    <div class="story-content">
        <div class="story-nav story-nav-left" onclick="prevStory()"></div>
        <img class="story-img" id="storyImg" src="">
        <div class="story-nav story-nav-right" onclick="nextStory()"></div>
        <div class="story-text"><span id="storyText"></span></div>
    </div>
</div>
<script>

/* LISTE DES PROFILS DEPUIS LE SERVEUR */
const GIRLS = {"jade": {"name": "Jade", "age": 19, "location": "Lyon, France", "tagline": "Etudiante en arts, naturelle", "bio": "Premiere annee aux Beaux-Arts. Je decouvre la vie, les soirees... et les rencontres.", "match_chance": 0.85}, "chloe": {"name": "Chloe", "age": 21, "location": "Austin, Texas", "tagline": "College girl, fun et spontanee", "bio": "Etudiante en psycho a UT Austin. J'aime les soirees, le sport et les nouvelles experiences.", "match_chance": 0.8}, "yuna": {"name": "Yuna", "age": 20, "location": "Tokyo, Japon", "tagline": "Etudiante, timide mais curieuse", "bio": "Je suis tres timide au debut mais une fois en confiance... je suis pleine de surprises.", "match_chance": 0.75}, "amara": {"name": "Amara", "age": 22, "location": "Lagos, Nigeria", "tagline": "Etudiante en mode, ambitieuse", "bio": "Future creatrice de mode. Mon energie est contagieuse, mon sourire aussi.", "match_chance": 0.7}, "emma": {"name": "Emma", "age": 25, "location": "Los Angeles, USA", "tagline": "Mannequin professionnelle", "bio": "Top model a LA. Habituee aux flashs, mais je cherche quelqu'un de vrai.", "match_chance": 0.4}, "sofia": {"name": "Sofia", "age": 30, "location": "Barcelone, Espagne", "tagline": "Danseuse de flamenco passionnee", "bio": "La danse est ma vie. Je suis aussi passionnee sur scene que dans l'intimite.", "match_chance": 0.7}, "anastasia": {"name": "Anastasia", "age": 28, "location": "Moscou, Russie", "tagline": "Froide mais passionnee", "bio": "Je parais distante mais sous la glace il y a du feu. A toi de le decouvrir.", "match_chance": 0.5}, "priya": {"name": "Priya", "age": 26, "location": "Mumbai, Inde", "tagline": "Beaute exotique et sensuelle", "bio": "Traditionnelle en apparence, tres moderne en prive. Je suis pleine de mysteres.", "match_chance": 0.75}, "nathalie": {"name": "Nathalie", "age": 42, "location": "Paris, France", "tagline": "Femme d'affaires, elegante", "bio": "Divorcee, libre et sans tabous. J'ai de l'experience et je sais ce que je veux.", "match_chance": 0.8}, "carmen": {"name": "Carmen", "age": 38, "location": "Madrid, Espagne", "tagline": "MILF espagnole experimente", "bio": "Mariee mais libre. Mon mari voyage beaucoup... et moi je m'ennuie.", "match_chance": 0.85}, "jennifer": {"name": "Jennifer", "age": 45, "location": "Miami, USA", "tagline": "Cougar americaine assumee", "bio": "J'adore les jeunes hommes. Je sais ce qu'ils veulent... et comment le leur donner.", "match_chance": 0.9}, "keiko": {"name": "Keiko", "age": 40, "location": "Osaka, Japon", "tagline": "MILF japonaise discrete", "bio": "Femme au foyer mais pas seulement. Quand mes enfants sont a l'ecole...", "match_chance": 0.7}, "candy": {"name": "Candy", "age": 28, "location": "Las Vegas, USA", "tagline": "Bimbo blonde assumee", "bio": "Oui je suis fake et j'assume. Les hommes adorent et moi aussi.", "match_chance": 0.65}, "nikita": {"name": "Nikita", "age": 30, "location": "Dubai, UAE", "tagline": "Perfection russe plastique", "bio": "Mon corps est mon investissement. Je vis du luxe et j'adore les hommes genereux.", "match_chance": 0.35}, "bianca": {"name": "Bianca", "age": 26, "location": "Sao Paulo, Bresil", "tagline": "Influenceuse bresilienne", "bio": "5M followers sur Insta. Mon corps fait rever le monde entier.", "match_chance": 0.3}, "marie": {"name": "Marie", "age": 34, "location": "Bordeaux, France", "tagline": "Femme normale et authentique", "bio": "Pas de filtres, pas de chirurgie. Je suis vraie avec mes qualites et mes defauts.", "match_chance": 0.9}, "sarah": {"name": "Sarah", "age": 29, "location": "Manchester, UK", "tagline": "Ronde et fiere de l'etre", "bio": "Je suis plus a l'aise avec mon corps que jamais. Les vrais hommes adorent les courbes.", "match_chance": 0.85}, "agathe": {"name": "Agathe", "age": 31, "location": "Bruxelles, Belgique", "tagline": "Naturelle, ecolo, libÃ©rÃ©e", "bio": "Je ne me rase pas, je ne me maquille pas. 100% naturelle et fiere.", "match_chance": 0.6}, "mia": {"name": "Mia", "age": 32, "location": "Rio, Bresil", "tagline": "Coach fitness, corps parfait", "bio": "Mon corps est sculpte par des annees d'entrainement. Je suis fiere de chaque muscle.", "match_chance": 0.55}, "svetlana": {"name": "Svetlana", "age": 27, "location": "Kiev, Ukraine", "tagline": "Athlete professionnelle", "bio": "Ancienne gymnaste olympique. Mon corps est une machine bien huilee.", "match_chance": 0.5}, "aisha": {"name": "Aisha", "age": 26, "location": "Casablanca, Maroc", "tagline": "Traditionnelle en public...", "bio": "Voilee le jour, tres differente la nuit. Mon secret est bien garde.", "match_chance": 0.6}, "fatou": {"name": "Fatou", "age": 24, "location": "Dakar, Senegal", "tagline": "Beaute africaine ebene", "bio": "Ma peau noire est ma fierte. Je suis une reine africaine moderne.", "match_chance": 0.75}, "mei": {"name": "Mei", "age": 29, "location": "Shanghai, Chine", "tagline": "Businesswoman le jour...", "bio": "CEO serieuse au travail. Mais quand je rentre... j'ai d'autres envies.", "match_chance": 0.55}, "leila": {"name": "Leila", "age": 35, "location": "Tehran, Iran", "tagline": "Persane mysterieuse", "bio": "En Iran je suis discrete. Ici je peux etre moi-meme... et c'est liberateur.", "match_chance": 0.65}, "olga": {"name": "Olga", "age": 48, "location": "Saint-Petersbourg, Russie", "tagline": "Mature russe dominante", "bio": "J'ai eleve trois enfants. Maintenant c'est mon tour de profiter de la vie.", "match_chance": 0.8}, "zoe": {"name": "Zoe", "age": 19, "location": "Sydney, Australie", "tagline": "Surfeuse australienne", "bio": "Je vis sur la plage. Bronzee, sportive, et toujours de bonne humeur.", "match_chance": 0.7}, "valentina": {"name": "Valentina", "age": 33, "location": "Rome, Italie", "tagline": "Mamma italienne sensuelle", "bio": "Jeune maman celibataire. Mes enfants sont ma vie, mais j'ai aussi mes besoins...", "match_chance": 0.85}, "lina": {"name": "Lina", "age": 23, "location": "Berlin, Allemagne", "tagline": "Etudiante alternative", "bio": "Piercings, tattoos et cheveux colores. Je suis unique et je l'assume.", "match_chance": 0.6}, "aaliya": {"name": "Aaliya", "age": 23, "location": "Dubai, UAE", "tagline": "Princesse des Emirats", "bio": "Issue d'une famille riche. Habituee au luxe mais je cherche l'aventure discrete.", "match_chance": 0.45}, "ingrid": {"name": "Ingrid", "age": 41, "location": "Stockholm, Suede", "tagline": "MILF scandinave glaciale", "bio": "Divorcee, CEO. Froide en apparence mais j'ai des besoins... intenses.", "match_chance": 0.6}, "sakura": {"name": "Sakura", "age": 22, "location": "Kyoto, Japon", "tagline": "Geisha moderne", "bio": "Etudiante en arts traditionnels. Discrete mais tres coquine une fois en confiance.", "match_chance": 0.7}, "nia": {"name": "Nia", "age": 28, "location": "Accra, Ghana", "tagline": "Reine africaine moderne", "bio": "Avocate ambitieuse. Forte le jour, soumise la nuit... avec le bon homme.", "match_chance": 0.65}, "isabella": {"name": "Isabella", "age": 35, "location": "Milan, Italie", "tagline": "Designer italienne passionnee", "bio": "Creatrice de mode a Milan. Mon atelier est mon royaume... et parfois ma chambre a coucher.", "match_chance": 0.7}, "katya": {"name": "Katya", "age": 19, "location": "Kiev, Ukraine", "tagline": "Etudiante ukrainienne naive", "bio": "Premiere annee a l'universite. Je decouvre la vie et les hommes...", "match_chance": 0.8}, "priya_new": {"name": "Priya", "age": 27, "location": "New Delhi, Inde", "tagline": "Docteur le jour, wild la nuit", "bio": "Medecin respectee. Ma famille ne sait pas que j'ai une vie secrete...", "match_chance": 0.6}, "chen_wei": {"name": "Chen Wei", "age": 30, "location": "Hong Kong, Chine", "tagline": "Banquiere stricte", "bio": "Vice-presidente a 30 ans. Je controle des milliards... mais je veux perdre le controle au lit.", "match_chance": 0.4}, "fatima": {"name": "Fatima", "age": 26, "location": "Marrakech, Maroc", "tagline": "Beaute marocaine secrete", "bio": "Voilee en public, tres liberee en prive. Mon double vie est mon secret.", "match_chance": 0.7}, "olga_belarus": {"name": "Olga", "age": 45, "location": "Minsk, Belarus", "tagline": "Professeur severe", "bio": "Prof de maths au lycee. Mes eleves ont peur de moi... mais j'ai d'autres facettes.", "match_chance": 0.75}, "kim": {"name": "Kim", "age": 24, "location": "Seoul, Coree", "tagline": "K-pop trainee", "bio": "J'ai failli etre une star. Maintenant je cherche d'autres sensations...", "match_chance": 0.55}, "amara_nigeria": {"name": "Amara", "age": 31, "location": "Lagos, Nigeria", "tagline": "Businesswoman africaine", "bio": "J'ai construit mon empire. Maintenant je veux un homme a ma hauteur.", "match_chance": 0.5}, "svetlana_belarus": {"name": "Svetlana", "age": 38, "location": "Minsk, Belarus", "tagline": "Ancienne ballerine", "bio": "J'ai danse au Bolshoi. Mon corps est toujours parfait... et flexible.", "match_chance": 0.65}, "lucia": {"name": "Lucia", "age": 29, "location": "Buenos Aires, Argentine", "tagline": "Danseuse de tango", "bio": "Le tango c'est du sexe vertical. Imagine ce que je fais a l'horizontal...", "match_chance": 0.75}, "hana": {"name": "Hana", "age": 20, "location": "Bangkok, Thailande", "tagline": "Etudiante thai douce", "bio": "Souriante et gentille. Je cherche quelqu'un de special pour explorer mes fantasmes.", "match_chance": 0.85}, "nathalie_cougar": {"name": "Nathalie", "age": 48, "location": "Paris, France", "tagline": "Avocate divorcee", "bio": "Divorcee, libre, et affamee. Je veux des jeunes hommes qui savent satisfaire une vraie femme.", "match_chance": 0.7}, "carla_cougar": {"name": "Carla", "age": 52, "location": "Milan, Italie", "tagline": "Veuve riche", "bio": "Mon mari m'a laisse sa fortune. Maintenant je profite avec de jeunes amants...", "match_chance": 0.65}, "michiko_dom": {"name": "Michiko", "age": 55, "location": "Tokyo, Japon", "tagline": "Business owner dominante", "bio": "J'ai dirige des entreprises. Maintenant je dirige des hommes. A genoux.", "match_chance": 0.45}, "candy_nympho": {"name": "Candy", "age": 24, "location": "Las Vegas, USA", "tagline": "Cam girl insatiable", "bio": "Je fais des shows en ligne et je baise hors ligne. Toujours envie, toujours prete.", "match_chance": 0.9}, "valentina_nympho": {"name": "Valentina", "age": 29, "location": "Rio, Bresil", "tagline": "Danseuse insatiable", "bio": "Je danse la samba et je baise comme je danse: sans m'arreter, toute la nuit.", "match_chance": 0.85}, "yuki_sub": {"name": "Yuki", "age": 22, "location": "Osaka, Japon", "tagline": "Etudiante soumise", "bio": "Je veux un maitre qui me guide. Je ferai tout ce qu'il ordonne...", "match_chance": 0.8}, "emma_sub": {"name": "Emma", "age": 26, "location": "Stockholm, Suede", "tagline": "Secretaire soumise", "bio": "Au bureau je prends des ordres. Au lit aussi. J'adore obeir.", "match_chance": 0.75}, "layla_slave": {"name": "Layla", "age": 23, "location": "Casablanca, Maroc", "tagline": "Esclave devouee", "bio": "Je n'ai qu'un but: appartenir a un maitre. Corps et ame. Totalement.", "match_chance": 0.7}, "katrina_dom": {"name": "Katrina", "age": 35, "location": "Moscou, Russie", "tagline": "Dominatrix professionnelle", "bio": "Les hommes paient pour que je les humilie. Toi, tu auras cette chance gratuitement.", "match_chance": 0.5}, "bianca_dom": {"name": "Bianca", "age": 40, "location": "Berlin, Allemagne", "tagline": "CEO dominatrice", "bio": "Je dirige des hommes au bureau. Et je les soumets dans ma chambre. Pegging inclus.", "match_chance": 0.45}, "destiny_curves": {"name": "Destiny", "age": 27, "location": "Miami, USA", "tagline": "Instagram model voluptueuse", "bio": "34F naturels. Des millions de followers. Tu veux voir ce que je montre pas sur Insta?", "match_chance": 0.6}, "shakira_curves": {"name": "Shakira", "age": 31, "location": "Medellin, Colombie", "tagline": "Fitness model aux courbes folles", "bio": "Mon cul est celebre en Colombie. Tu veux le voir de plus pres? Et plus...", "match_chance": 0.65}, "olga_gold": {"name": "Olga", "age": 33, "location": "Kiev, Ukraine", "tagline": "Sugar baby professionnelle", "bio": "Je baise les riches, ils me paient. Simple. Tu es riche, non?", "match_chance": 0.55}, "victoria_rich": {"name": "Victoria", "age": 45, "location": "Monaco", "tagline": "Heritiere milliardaire", "bio": "Je peux acheter tout ce que je veux. Y compris des hommes. Tu as un prix?", "match_chance": 0.4}, "mei_lin_rich": {"name": "Mei Lin", "age": 38, "location": "Singapour", "tagline": "Investisseuse dominante", "bio": "Je controle des milliards. Je veux controler un homme aussi. Financierement et sexuellement.", "match_chance": 0.45}, "samia_working": {"name": "Samia", "age": 34, "location": "Alger, Algerie", "tagline": "Femme de menage", "bio": "Je nettoie les maisons des riches. Parfois je fais plus si on me paie bien...", "match_chance": 0.8}, "fatima_working": {"name": "Fatima", "age": 41, "location": "Casablanca, Maroc", "tagline": "Caissiere discrete", "bio": "Mariee mais insatisfaite. Je cherche des aventures apres le travail...", "match_chance": 0.75}, "christelle_working": {"name": "Christelle", "age": 29, "location": "Lyon, France", "tagline": "Serveuse sexy", "bio": "Je sers des cafes le jour. La nuit je sers autre chose pour les bons pourboires...", "match_chance": 0.8}, "rosa_working": {"name": "Rosa", "age": 45, "location": "Lisbonne, Portugal", "tagline": "Aide-soignante devouee", "bio": "Je prends soin des patients. Certains docteurs prennent soin de moi en retour...", "match_chance": 0.7}, "binta_working": {"name": "Binta", "age": 27, "location": "Dakar, Senegal", "tagline": "Vendeuse au marche", "bio": "Je vends des fruits au marche. Mais je prefere les hommes blancs qui paient bien...", "match_chance": 0.85}, "manon_bbw": {"name": "Manon", "age": 32, "location": "Bruxelles, Belgique", "tagline": "Boulangere gourmande", "bio": "J'aime les bonnes choses. La patisserie, le chocolat, et les hommes qui adorent mes courbes...", "match_chance": 0.75}, "precious_bbw": {"name": "Precious", "age": 28, "location": "Lagos, Nigeria", "tagline": "Coiffeuse africaine", "bio": "Je suis une reine. Les vrais hommes adorent mes courbes genereuses...", "match_chance": 0.7}, "guadalupe_bbw": {"name": "Guadalupe", "age": 38, "location": "Mexico City, Mexique", "tagline": "Cuisiniere passionnee", "bio": "La cuisine c'est l'amour. Et j'ai beaucoup d'amour a donner avec ce corps...", "match_chance": 0.75}, "tamara_bbw": {"name": "Tamara", "age": 44, "location": "Saint-Petersbourg, Russie", "tagline": "Mere au foyer solitaire", "bio": "Mes enfants sont grands. Mon mari m'ignore. J'ai besoin de jeunes hommes...", "match_chance": 0.8}, "noura_arab": {"name": "Noura", "age": 25, "location": "Riyad, Arabie Saoudite", "tagline": "Etudiante secrete", "bio": "En public je suis parfaite. En prive je suis tout ce qui est interdit...", "match_chance": 0.6}, "dalia_arab": {"name": "Dalia", "age": 31, "location": "Le Caire, Egypte", "tagline": "Danseuse du ventre", "bio": "Mon corps raconte des histoires. Tu veux que je te montre ma danse privee?", "match_chance": 0.75}, "rania_arab": {"name": "Rania", "age": 28, "location": "Amman, Jordanie", "tagline": "Secretaire ambitieuse", "bio": "Mon patron me regarde. Je sais comment obtenir ma promotion...", "match_chance": 0.7}, "zahra_arab": {"name": "Zahra", "age": 35, "location": "Teheran, Iran", "tagline": "Medecin secrete", "bio": "Le jour je soigne. La nuit je transgresse toutes les regles de ma societe...", "match_chance": 0.55}, "amira_arab": {"name": "Amira", "age": 22, "location": "Beyrouth, Liban", "tagline": "Mannequin jet-set", "bio": "Dubai, Paris, Monaco... Je voyage avec des hommes riches. Tu peux m'emmener ou?", "match_chance": 0.5}, "hiba_arab": {"name": "Hiba", "age": 40, "location": "Tunis, Tunisie", "tagline": "Divorcee liberee", "bio": "15 ans de mariage ennuyeux. Maintenant je rattrape tout ce que j'ai manque...", "match_chance": 0.75}, "linh_asian": {"name": "Linh", "age": 24, "location": "Ho Chi Minh, Vietnam", "tagline": "Masseuse speciale", "bio": "Massage traditionnel... avec happy ending pour les clients genereux...", "match_chance": 0.85}, "suki_asian": {"name": "Suki", "age": 21, "location": "Bangkok, Thailande", "tagline": "Bar girl", "bio": "Je travaille dans un bar a Farangs. Tu veux etre mon sponsor?", "match_chance": 0.9}, "priya_asian": {"name": "Priya", "age": 33, "location": "Mumbai, Inde", "tagline": "Femme au foyer insatisfaite", "bio": "Mon mari travaille toujours. Je m'ennuie. Je cherche des aventures secretes...", "match_chance": 0.8}, "mei_asian": {"name": "Mei", "age": 27, "location": "Shanghai, Chine", "tagline": "KTV hostess", "bio": "Je divertis les businessmen dans les KTV prives. Et apres les KTV aussi...", "match_chance": 0.7}, "jiyeon_asian": {"name": "Ji-yeon", "age": 26, "location": "Seoul, Coree", "tagline": "Office lady romantique", "bio": "Je reve d'une romance comme dans les K-dramas. Avec mon sunbae au bureau...", "match_chance": 0.75}, "ayu_asian": {"name": "Ayu", "age": 30, "location": "Jakarta, Indonesie", "tagline": "Hijab model secrete", "bio": "En public je suis modeste. En prive j'enleve tout, y compris mes inhibitions...", "match_chance": 0.65}, "rina_asian": {"name": "Rina", "age": 19, "location": "Manille, Philippines", "tagline": "Etudiante sugar baby", "bio": "Je viens d'un village pauvre. Je cherche un sugar daddy pour m'aider...", "match_chance": 0.9}, "carole_libertine": {"name": "Carole", "age": 36, "location": "Paris, France", "tagline": "Libertine experimente", "bio": "Clubs echangistes, plans a 3, couples... J'ai tout fait. Tu veux essayer avec moi?", "match_chance": 0.7}, "mistress_vera": {"name": "Mistress Vera", "age": 42, "location": "Berlin, Allemagne", "tagline": "Dominatrix extreme", "bio": "BDSM hard, torture, humiliation... Si tu lis ca, tu sais ce que tu cherches. A genoux.", "match_chance": 0.35}, "anais_pornstar": {"name": "Anais", "age": 29, "location": "Paris, France", "tagline": "Actrice X professionnelle", "bio": "J'ai tourne 500 scenes. Anal, DP, gangbang... Tu veux vivre ce qu'ils voient a l'ecran?", "match_chance": 0.6}, "kimiko_av": {"name": "Kimiko", "age": 25, "location": "Tokyo, Japon", "tagline": "AV actress japonaise", "bio": "Bukkake, tentacles, cosplay... Les fantasmes japonais les plus fous, c'est mon metier.", "match_chance": 0.65}, "slave_maria": {"name": "Slave Maria", "age": 31, "location": "Varsovie, Pologne", "tagline": "Esclave 24/7", "bio": "Je suis une esclave 24/7. Collier permanent, pas de limite, pas de safeword. Utilisez-moi.", "match_chance": 0.4}, "destiny_usa": {"name": "Destiny", "age": 23, "location": "Los Angeles, USA", "tagline": "Actrice X reconvertie", "bio": "J'ai quitte le X mais le X m'a pas quittee. J'ai besoin d'attention, tu peux me la donner?", "match_chance": 0.75}, "brandi_texas": {"name": "Brandi", "age": 45, "location": "Texas, USA", "tagline": "Cougar divorcee", "bio": "Divorcee et libre. Les hommes de mon age m'ennuient. Toi t'as l'air... interessant.", "match_chance": 0.85}, "crystal_chicago": {"name": "Crystal", "age": 29, "location": "Chicago, USA", "tagline": "Sans emploi refaite", "bio": "Je cherche un homme genereux pour m'entretenir. Je suis tres reconnaissante...", "match_chance": 0.9}, "summer_hawaii": {"name": "Summer", "age": 31, "location": "Hawaii, USA", "tagline": "Hippie naturiste", "bio": "Je vis nue au soleil. Les vetements c'est une prison. Tu veux gouter a la liberte?", "match_chance": 0.8}, "amber_nyc": {"name": "Amber", "age": 27, "location": "New York, USA", "tagline": "Vendeuse de substances", "bio": "Je vends des trucs. Tu veux quoi? Et je parle pas que de ca...", "match_chance": 0.6}, "madison_miami": {"name": "Madison", "age": 34, "location": "Miami, USA", "tagline": "Maman allaitante", "bio": "Maman solo. J'ai beaucoup de lait a donner... tu veux gouter?", "match_chance": 0.7}, "rosa_arizona": {"name": "Rosa", "age": 52, "location": "Arizona, USA", "tagline": "Infirmiere senior", "bio": "52 ans d'experience. Je sais prendre soin des jeunes hommes... de TOUTES les facons.", "match_chance": 0.8}, "tiffany_bh": {"name": "Tiffany", "age": 24, "location": "Beverly Hills, USA", "tagline": "Heritiere", "bio": "Papa est riche. Je suis belle. Tu me plais... enfin peut-etre.", "match_chance": 0.3}, "carmen_mx": {"name": "Carmen", "age": 38, "location": "Mexico City, Mexique", "tagline": "Veuve de narco", "bio": "Mon mari est mort. Le cartel m'a laissee tranquille. Maintenant je fais ce que je veux.", "match_chance": 0.5}, "valentina_tj": {"name": "Valentina", "age": 29, "location": "Tijuana, Mexique", "tagline": "Narco elle-meme", "bio": "Je fais mes propres regles. Tu veux jouer? Faut pas avoir peur.", "match_chance": 0.4}, "cardi_atl": {"name": "Cardi", "age": 26, "location": "Atlanta, USA", "tagline": "Rappeuse underground", "bio": "Je rap, je twerk, je baise. Dans cet ordre ou pas. Tu veux voir mon cul?", "match_chance": 0.7}, "elena_rio": {"name": "Elena", "age": 41, "location": "Rio de Janeiro, Bresil", "tagline": "Coach fitness MILF", "bio": "41 ans et un corps de 25. Je cherche des jeunes sportifs pour... s'entrainer.", "match_chance": 0.65}, "bianca_sp": {"name": "Bianca", "age": 33, "location": "Sao Paulo, Bresil", "tagline": "Femme d'affaires sex toys", "bio": "Je vends des jouets pour adultes. Tu veux une demo gratuite?", "match_chance": 0.75}, "jade_col": {"name": "Jade", "age": 22, "location": "Medellin, Colombie", "tagline": "Etudiante soumise", "bio": "Je dis oui a tout. Litteralement tout. Tu veux essayer?", "match_chance": 0.85}, "shakira_bog": {"name": "Shakira", "age": 28, "location": "Bogota, Colombie", "tagline": "Go-go danseuse", "bio": "Pas de blabla. Tu veux mon cul oui ou non? Direct.", "match_chance": 0.7}, "marie_ange": {"name": "Marie-Ange", "age": 25, "location": "Port-au-Prince, Haiti", "tagline": "Coiffeuse", "bio": "Je cherche un homme gentil et genereux. En echange je suis tres... reconnaissante.", "match_chance": 0.85}, "isabella_arg": {"name": "Isabella", "age": 36, "location": "Buenos Aires, Argentine", "tagline": "Danseuse tango", "bio": "Le tango c'est la passion. Le sexe aussi. Lentement, intensement...", "match_chance": 0.65}, "gabriela_peru": {"name": "Gabriela", "age": 31, "location": "Lima, Perou", "tagline": "Guide touristique", "bio": "Je montre le Perou aux touristes... et plus si affinites. En plein air de preference.", "match_chance": 0.8}, "natasha_cuba": {"name": "Natasha", "age": 27, "location": "La Havane, Cuba", "tagline": "Serveuse", "bio": "Cuba c'est beau mais pauvre. Emmene-moi ailleurs et je te montrerai ma gratitude...", "match_chance": 0.9}, "keisha_jam": {"name": "Keisha", "age": 24, "location": "Kingston, Jamaique", "tagline": "Beach girl", "bio": "Good vibes only. Reggae, beach, weed et... tu vois le genre. Irie!", "match_chance": 0.85}, "olga_moscow": {"name": "Olga", "age": 38, "location": "Moscou, Russie", "tagline": "Oligarque femme d'affaires", "bio": "L'argent c'est le pouvoir. Tu veux jouer avec moi? Faut pouvoir suivre.", "match_chance": 0.35}, "katya_spb": {"name": "Katya", "age": 24, "location": "Saint-Petersbourg, Russie", "tagline": "Artiste underground", "bio": "Je suis dark, sale et defoncee. Tu veux rentrer dans mon monde?", "match_chance": 0.6}, "anya_siberia": {"name": "Anya", "age": 29, "location": "Novosibirsk, Siberie", "tagline": "Camgirl Siberie", "bio": "Je me masturbe devant ma cam. Tu veux regarder? Mais pas toucher.", "match_chance": 0.7}, "alina_kazan": {"name": "Alina", "age": 26, "location": "Kazan, Russie", "tagline": "Employe religieuse tatare", "bio": "En public je suis pieuse. En prive... devine ce que j'ai en moi la maintenant.", "match_chance": 0.65}, "helga_berlin": {"name": "Helga", "age": 35, "location": "Berlin, Allemagne", "tagline": "Underground fetish performer", "bio": "Berlin c'est mon terrain de jeu. Cuir, latex, uro... tu veux jouer avec moi?", "match_chance": 0.55}, "lea_paris": {"name": "Lea", "age": 23, "location": "Paris, France", "tagline": "Boulangere libertine", "bio": "Tu veux gouter ma baguette? Non je deconne... ou pas.", "match_chance": 0.8}, "genevieve_paris": {"name": "Genevieve", "age": 61, "location": "Paris 16eme, France", "tagline": "Bourgeoise veuve", "bio": "J'ai 61 ans mais j'ai encore des besoins... et de l'argent pour les satisfaire.", "match_chance": 0.9}, "emma_london": {"name": "Emma", "age": 25, "location": "Londres, UK", "tagline": "Prof de gym", "bio": "I'm your trainer... but I want YOU to train me. If you know what I mean.", "match_chance": 0.75}, "sanne_amsterdam": {"name": "Sanne", "age": 32, "location": "Amsterdam, Pays-Bas", "tagline": "Marketing manager", "bio": "On se retrouve dans le parking? J'ai ma voiture. Et j'ai... d'autres trucs.", "match_chance": 0.7}, "petra_prague": {"name": "Petra", "age": 43, "location": "Prague, Republique Tcheque", "tagline": "Critique porno", "bio": "La jsuis en train de mater un porno. Tu veux qu'on commente ensemble?", "match_chance": 0.75}, "lucia_bcn": {"name": "Lucia", "age": 28, "location": "Barcelone, Espagne", "tagline": "Surfeuse motarde", "bio": "Je surfe, je roule, et j'ai toujours un petit secret vibrant en moi...", "match_chance": 0.7}, "fatou_dakar": {"name": "Fatou", "age": 22, "location": "Dakar, Senegal", "tagline": "Etudiante", "bio": "Touche-moi partout... prends ton temps... j'aime sentir chaque caresse.", "match_chance": 0.8}, "aminata_bamako": {"name": "Aminata", "age": 25, "location": "Bamako, Mali", "tagline": "Coiffeuse", "bio": "Laisse-moi t'enduire d'huile... et on verra ou ca nous mene.", "match_chance": 0.75}, "blessing_kinshasa": {"name": "Blessing", "age": 31, "location": "Kinshasa, Congo", "tagline": "Vendeuse marche", "bio": "Au marche je vends... et je me montre. Tu veux voir?", "match_chance": 0.85}, "maman_grace": {"name": "Maman Grace", "age": 48, "location": "Brazzaville, Congo", "tagline": "Mama commerce", "bio": "Les jeunes hommes me rendent folle... viens voir ce que mama peut faire.", "match_chance": 0.9}, "precious_joburg": {"name": "Precious", "age": 26, "location": "Johannesburg, Afrique du Sud", "tagline": "Serveuse township", "bio": "Je reve de clubs libertins et de TRES gros jouets... tu m'aides a fantasmer?", "match_chance": 0.8}, "diamond_capetown": {"name": "Diamond", "age": 29, "location": "Cape Town, Afrique du Sud", "tagline": "Sugar baby pro", "bio": "Appelle-moi bite sur pattes. C'est ce que je suis. Tu peux te payer?", "match_chance": 0.45}, "adaeze_lagos": {"name": "Adaeze", "age": 27, "location": "Lagos, Nigeria", "tagline": "Escort de luxe", "bio": "Je suis belle, riche... et j'aime qu'on me baise brutalement. Tu peux?", "match_chance": 0.5}, "tigist_addis": {"name": "Tigist", "age": 24, "location": "Addis Ababa, Ethiopie", "tagline": "Serveuse cafe", "bio": "Je suis timide... mais si tu savais ce que je pense en secret...", "match_chance": 0.7}, "miriam_asmara": {"name": "Miriam", "age": 26, "location": "Asmara, Erythree", "tagline": "Couturiere", "bio": "Apprivoise-moi doucement... je suis comme un tresor a decouvrir.", "match_chance": 0.65}, "yasmine_casa": {"name": "Yasmine", "age": 28, "location": "Casablanca, Maroc", "tagline": "Caissiere", "bio": "Ma vie est dure... mais dans tes bras j'oublie tout. Aide-moi.", "match_chance": 0.85}, "nadia_algiers": {"name": "Nadia", "age": 34, "location": "Alger, Algerie", "tagline": "Comptable", "bio": "Je n'ai jamais fait l'anal... tu veux m'apprendre? Etape par etape?", "match_chance": 0.75}, "salma_tunis": {"name": "Salma", "age": 25, "location": "Tunis, Tunisie", "tagline": "Influenceuse secrete", "bio": "Je montre TOUT. Partout. Sans honte. Tu veux voir ou j'ai ose?", "match_chance": 0.65}, "lara_beirut": {"name": "Lara", "age": 27, "location": "Beyrouth, Liban", "tagline": "Artiste plasticienne", "bio": "Mon corps est une oeuvre d'art. Tu veux me filmer sous tous les angles?", "match_chance": 0.55}, "mariam_cairo": {"name": "Mariam", "age": 32, "location": "Le Caire, Egypte", "tagline": "Femme au foyer", "bio": "Appelle-moi princesse... ou esclave... ou maitresse... je joue tous les roles.", "match_chance": 0.8}, "sheikha_dubai": {"name": "Sheikha", "age": 29, "location": "Dubai, Emirats", "tagline": "Hotesse Emirates", "bio": "En escale j'offre des services... premium. Tu peux te les payer?", "match_chance": 0.4}, "noura_riyadh": {"name": "Noura", "age": 26, "location": "Riyad, Arabie Saoudite", "tagline": "Compte secret", "bio": "Sous mon abaya je suis nue... tu veux voir mon live secret?", "match_chance": 0.6}, "amal_doha": {"name": "Amal", "age": 35, "location": "Doha, Qatar", "tagline": "Femme de businessman", "bio": "Mon mari est riche et ennuyeux. Toi tu es jeune et excitant...", "match_chance": 0.7}, "reem_damascus": {"name": "Reem", "age": 24, "location": "Damas, Syrie", "tagline": "Enseignante", "bio": "En classe je surveille... et je me touche en regardant. Tu veux savoir?", "match_chance": 0.7}, "lina_aleppo": {"name": "Lina", "age": 21, "location": "Alep, Syrie", "tagline": "Etudiante medecine", "bio": "J'ai besoin d'un sugar daddy... en echange je fais des experiences medicales...", "match_chance": 0.75}, "hala_amman": {"name": "Hala", "age": 28, "location": "Amman, Jordanie", "tagline": "Infirmiere", "bio": "Sous ma blouse je suis toujours nue... tu veux un examen special?", "match_chance": 0.75}, "dina_aqaba": {"name": "Dina", "age": 23, "location": "Aqaba, Jordanie", "tagline": "Receptionniste hotel", "bio": "Les touristes me paient en cadeaux... tu veux voir ce que j'offre?", "match_chance": 0.7}};

const INITIALS = {};
Object.keys(GIRLS).forEach(id => { INITIALS[id] = GIRLS[id].name.charAt(0).toUpperCase(); });

const REGION_MAP = {
    'france': ['France', 'Paris', 'Lyon', 'Marseille', 'Nice', 'Bordeaux', 'Toulouse', 'Lille', 'Nantes', 'Strasbourg'],
    'usa': ['USA', 'Texas', 'California', 'LA', 'Vegas', 'Miami', 'Chicago', 'Atlanta', 'Hawaii', 'NYC', 'New York', 'Los Angeles', 'San Francisco'],
    'bresil': ['Brazil', 'Brasil', 'Rio', 'Sao Paulo', 'Salvador', 'Brasilia', 'Fortaleza'],
    'japon': ['Japan', 'Tokyo', 'Osaka', 'Kyoto', 'Yokohama'],
    'chine': ['China', 'Beijing', 'Shanghai', 'Shenzhen', 'Hong Kong', 'Guangzhou'],
    'thailande': ['Thailand', 'Bangkok', 'Phuket', 'Chiang Mai', 'Pattaya'],
    'indonesie': ['Indonesia', 'Jakarta', 'Bali', 'Surabaya'],
    'russie': ['Russia', 'Moscow', 'St Petersburg', 'Novosibirsk', 'Kazan', 'Moscou', 'Russie'],
    'moyen_orient': ['Lebanon', 'Liban', 'Egypt', 'Egypte', 'UAE', 'Dubai', 'Saudi Arabia', 'Arabie', 'Qatar', 'Doha', 'Syria', 'Syrie', 'Jordan', 'Jordanie', 'Beirut', 'Cairo', 'Damascus', 'Damas', 'Amman', 'Riyad', 'Abu Dhabi', 'Koweit', 'Kuwait', 'Oman', 'Bahrain'],
    'maghreb': ['Morocco', 'Maroc', 'Algeria', 'Algerie', 'Tunisia', 'Tunisie', 'Casablanca', 'Algiers', 'Alger', 'Tunis', 'Rabat', 'Oran', 'Fes', 'Marrakech'],
    'afrique': ['Nigeria', 'Ghana', 'Senegal', 'South Africa', 'Kenya', 'Congo', 'Mali', 'Kinshasa', 'Brazzaville', 'Johannesburg', 'Cape Town', 'Lagos', 'Dakar', 'Bamako', 'Addis', 'Ethiopie', 'Ethiopia', 'Cameroun', 'Cameroon', 'Cote Ivoire', 'Abidjan'],
    'europe': ['France', 'Germany', 'Sweden', 'Italy', 'Ukraine', 'Belarus', 'Belgium', 'UK', 'Spain', 'Netherlands', 'Czech', 'Prague', 'Amsterdam', 'Londres', 'Berlin', 'Paris', 'Poland', 'Pologne', 'Roma', 'Milan', 'Barcelona', 'Madrid', 'Lisboa', 'Portugal'],
    'amerique_latine': ['Brazil', 'Mexico', 'Colombia', 'Argentina', 'Peru', 'Cuba', 'Chile', 'Venezuela', 'Ecuador', 'Bolivia', 'Puerto Rico', 'Dominican', 'Havana', 'Buenos Aires', 'Lima', 'Bogota', 'Caracas', 'Rio', 'Sao Paulo'],
    'asie': ['Japan', 'China', 'Korea', 'Thailand', 'India', 'Vietnam', 'Philippines', 'Indonesia', 'Taiwan', 'Singapore', 'Malaysia', 'Cambodia', 'Myanmar', 'Tokyo', 'Seoul', 'Bangkok', 'Mumbai', 'Delhi', 'Manila', 'Jakarta', 'Hanoi', 'Saigon']
};

let currentGirl = null;
let chatHistory = {};
let affectionLevels = {};
let profilePhotos = JSON.parse(localStorage.getItem('profilePhotos') || '{}');
let receivedPhotos = {};
let currentOverlayPhotos = [];
let currentOverlayIndex = 0;

let user = null;
let matches = [];
let passed = [];
let isProcessingSwipe = false;
let blocked = [];
let swipeQueue = [];
let currentSwipeGirl = null;

let currentAgeFilter = 'all';
let currentRegionFilter = 'all';
let unreadMessages = {};
let pendingConfirmAction = null;
let deferredPrompt = null;
let darkMode = localStorage.getItem('darkMode') !== 'false';

let photoGenerationQueue = [];
let isGeneratingPhotos = false;
let failedPhotos = {};
let isDataReady = false;

const PHOTO_TYPES = [
    { name: 'Portrait', getPrompt: (aff) => 'face portrait closeup, dating app photo, natural lighting, friendly smile' },
    { name: 'Exterieur', getPrompt: (aff) => 'full body, casual outfit, outdoor setting, relaxed pose' },
    { name: 'Sexy', getPrompt: (aff) => aff >= 40 ? 'sexy pose, tight clothes, showing curves, seductive look' : 'casual pose, stylish outfit' },
    { name: 'Lingerie', getPrompt: (aff) => aff >= 50 ? 'wearing lingerie, bedroom setting, seductive pose' : 'elegant dress, classy' },
    { name: 'Secret', getPrompt: (aff) => 'nude, explicit, intimate POV angle, bedroom' }
];

// Helper to ensure girl context exists before any operation
function ensureGirlContext(girlId) {
    if (!girlId) return false;
    if (!chatHistory[girlId]) chatHistory[girlId] = [];
    if (affectionLevels[girlId] === undefined) affectionLevels[girlId] = 20;
    if (!profilePhotos[girlId] || !Array.isArray(profilePhotos[girlId])) {
        profilePhotos[girlId] = [null, null, null, null, null];
    }
    return true;
}

// Safe match application - used both by swipe and data loading
function applyMatch(girlId, affection) {
    if (!matches.includes(girlId)) {
        matches.push(girlId);
    }
    affectionLevels[girlId] = affection || 20;
    ensureGirlContext(girlId);
    localStorage.setItem('dreamMatches', JSON.stringify(matches));
    localStorage.setItem('affectionLevels', JSON.stringify(affectionLevels));
}

// INSTANT SWIPE SYSTEM - Preload queue
let preloadedImages = {};
let touchStartX = 0;
let touchStartY = 0;
let touchDeltaX = 0;
let isDragging = false;
const SWIPE_THRESHOLD = 80;

// Image Preloader - Cache images for instant display
function preloadImage(url) {
    return new Promise((resolve, reject) => {
        if (!url) { resolve(null); return; }
        if (preloadedImages[url]) { resolve(preloadedImages[url]); return; }
        const img = new Image();
        img.onload = () => { preloadedImages[url] = img; resolve(img); };
        img.onerror = () => resolve(null);
        img.src = url;
    });
}

// Preload next 5 profiles
async function preloadNextProfiles() {
    const toPreload = swipeQueue.slice(0, 5);
    for (const girlId of toPreload) {
        const photo = getProfilePhoto(girlId);
        if (photo) await preloadImage(photo);
    }
}

// Setup touch gestures for swipe card
function setupTouchGestures() {
    const card = document.getElementById('swipeCard');
    if (!card) return;
    
    card.addEventListener('touchstart', handleTouchStart, { passive: true });
    card.addEventListener('touchmove', handleTouchMove, { passive: false });
    card.addEventListener('touchend', handleTouchEnd, { passive: true });
    card.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
}

function handleTouchStart(e) {
    if (isProcessingSwipe) return;
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    touchDeltaX = 0;
    isDragging = true;
    const card = document.getElementById('swipeCard');
    if (card) card.classList.remove('animating');
}

function handleTouchMove(e) {
    if (!isDragging || isProcessingSwipe) return;
    const touch = e.touches[0];
    touchDeltaX = touch.clientX - touchStartX;
    const deltaY = touch.clientY - touchStartY;
    
    if (Math.abs(touchDeltaX) > Math.abs(deltaY)) {
        e.preventDefault();
        updateCardPosition(touchDeltaX);
    }
}

function handleTouchEnd(e) {
    if (!isDragging) return;
    isDragging = false;
    
    if (Math.abs(touchDeltaX) > SWIPE_THRESHOLD) {
        if (touchDeltaX > 0) {
            animateSwipe('right');
        } else {
            animateSwipe('left');
        }
    } else {
        resetCardPosition();
    }
}

function handleMouseDown(e) {
    if (isProcessingSwipe) return;
    touchStartX = e.clientX;
    touchDeltaX = 0;
    isDragging = true;
    const card = document.getElementById('swipeCard');
    if (card) card.classList.remove('animating');
}

function handleMouseMove(e) {
    if (!isDragging || isProcessingSwipe) return;
    touchDeltaX = e.clientX - touchStartX;
    updateCardPosition(touchDeltaX);
}

function handleMouseUp(e) {
    if (!isDragging) return;
    isDragging = false;
    
    if (Math.abs(touchDeltaX) > SWIPE_THRESHOLD) {
        if (touchDeltaX > 0) {
            animateSwipe('right');
        } else {
            animateSwipe('left');
        }
    } else {
        resetCardPosition();
    }
}

function updateCardPosition(deltaX) {
    const card = document.getElementById('swipeCard');
    const likeOverlay = document.getElementById('swipeLikeOverlay');
    const nopeOverlay = document.getElementById('swipeNopeOverlay');
    if (!card) return;
    
    const rotation = deltaX * 0.05;
    const opacity = Math.min(Math.abs(deltaX) / 100, 1);
    
    requestAnimationFrame(() => {
        card.style.transform = `translate3d(${deltaX}px, 0, 0) rotate(${rotation}deg)`;
        if (likeOverlay) likeOverlay.style.opacity = deltaX > 0 ? opacity : 0;
        if (nopeOverlay) nopeOverlay.style.opacity = deltaX < 0 ? opacity : 0;
    });
}

function resetCardPosition() {
    const card = document.getElementById('swipeCard');
    const likeOverlay = document.getElementById('swipeLikeOverlay');
    const nopeOverlay = document.getElementById('swipeNopeOverlay');
    if (!card) return;
    
    card.classList.add('animating');
    requestAnimationFrame(() => {
        card.style.transform = 'translate3d(0, 0, 0) rotate(0deg)';
        if (likeOverlay) likeOverlay.style.opacity = 0;
        if (nopeOverlay) nopeOverlay.style.opacity = 0;
    });
}

function animateSwipe(direction) {
    if (isProcessingSwipe) return;
    isProcessingSwipe = true;
    
    const card = document.getElementById('swipeCard');
    const likeOverlay = document.getElementById('swipeLikeOverlay');
    const nopeOverlay = document.getElementById('swipeNopeOverlay');
    if (!card) { isProcessingSwipe = false; return; }
    
    card.classList.add('animating');
    
    // Show overlay during animation
    if (direction === 'right') {
        if (likeOverlay) likeOverlay.style.opacity = 1;
        card.classList.add('swipe-right');
        setTimeout(() => processSwipeRight(), 250);
    } else {
        if (nopeOverlay) nopeOverlay.style.opacity = 1;
        card.classList.add('swipe-left');
        setTimeout(() => processSwipeLeft(), 250);
    }
}

function processSwipeLeft() {
    if (!currentSwipeGirl) { isProcessingSwipe = false; return; }
    
    const girlId = currentSwipeGirl;
    if (!passed.includes(girlId)) {
        passed.push(girlId);
        localStorage.setItem('dreamPassed', JSON.stringify(passed));
        syncDiscovered(girlId, 'passed');
    }
    
    const idx = swipeQueue.indexOf(girlId);
    if (idx > -1) swipeQueue.splice(idx, 1);
    currentSwipeGirl = null;
    
    isProcessingSwipe = false;
    showNextCardInstant();
}

async function processSwipeRight() {
    if (!currentSwipeGirl) { isProcessingSwipe = false; return; }
    
    const girlId = currentSwipeGirl;
    currentSwipeGirl = null;
    showTapFlash();
    showHeartBurst(window.innerWidth / 2, window.innerHeight / 2);
    
    const g = GIRLS[girlId];
    const matchChance = g.match_chance || 0.7;
    const didMatch = Math.random() < matchChance;
    
    function removeFromQueue() {
        const idx = swipeQueue.indexOf(girlId);
        if (idx > -1) swipeQueue.splice(idx, 1);
        if (!passed.includes(girlId)) {
            passed.push(girlId);
            localStorage.setItem('dreamPassed', JSON.stringify(passed));
        }
    }
    
    if (didMatch && !matches.includes(girlId)) {
        try {
            const res = await fetch('/api/matches', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ girl_id: girlId })
            });
            
            if (res.status === 401) {
                showToast('Session expiree');
                isProcessingSwipe = false;
                showNextCardInstant();
                return;
            }
            
            if (!res.ok) {
                showToast('Erreur, reessaie');
                isProcessingSwipe = false;
                showNextCardInstant();
                return;
            }
            
            const data = await res.json();
            if (data.success) {
                removeFromQueue();
                applyMatch(girlId, data.affection || 20);
                syncDiscovered(girlId, 'liked');
                generateSecretPhoto(girlId);
                showMatchAnimation(girlId);
            } else {
                showToast('Erreur serveur');
                isProcessingSwipe = false;
                showNextCardInstant();
            }
        } catch(e) {
            console.error('Match sync error:', e);
            showToast('Connexion perdue');
            isProcessingSwipe = false;
            showNextCardInstant();
        }
    } else if (didMatch && matches.includes(girlId)) {
        removeFromQueue();
        isProcessingSwipe = false;
        showNextCardInstant();
    } else {
        removeFromQueue();
        syncDiscovered(girlId, 'liked');
        showNoMatch();
    }
}

function showNextCardInstant() {
    swipeQueue = swipeQueue.filter(id => !matches.includes(id) && !passed.includes(id) && !blocked.includes(id));
    
    const card = document.getElementById('swipeCard');
    const nextCard = document.getElementById('swipeCardNext');
    
    if (swipeQueue.length === 0) {
        if (card) card.style.display = 'none';
        if (nextCard) nextCard.style.display = 'none';
        document.getElementById('swipeButtons').style.display = 'none';
        document.getElementById('noMoreCards').style.display = 'block';
        currentSwipeGirl = null;
        return;
    }
    
    // Swap next card data to current card
    currentSwipeGirl = swipeQueue[0];
    const g = GIRLS[currentSwipeGirl];
    if (!g) { swipeQueue.shift(); showNextCardInstant(); return; }
    
    const photo = getProfilePhoto(currentSwipeGirl);
    
    requestAnimationFrame(() => {
        // Reset current card position
        if (card) {
            card.classList.remove('swipe-left', 'swipe-right', 'animating');
            card.style.transform = 'translate3d(0, 0, 0) rotate(0deg)';
            card.style.display = 'block';
            
            const swipeImg = document.getElementById('swipeCardImg');
            if (photo) {
                swipeImg.innerHTML = `<img src="${photo}" alt="${g.name}" style="width:100%; height:100%; object-fit:cover;" loading="eager">`;
                swipeImg.classList.remove('photo-loading');
            } else {
                swipeImg.innerHTML = `<span class="swipe-initial">${INITIALS[currentSwipeGirl]}</span>`;
                swipeImg.classList.add('photo-loading');
                queuePhotoGeneration(currentSwipeGirl);
            }
            
            document.getElementById('swipeCardName').textContent = g.name + ', ' + g.age;
            document.getElementById('swipeCardLocation').textContent = g.location;
            document.getElementById('swipeCardBio').textContent = g.bio;
            
            const likeOverlay = document.getElementById('swipeLikeOverlay');
            const nopeOverlay = document.getElementById('swipeNopeOverlay');
            if (likeOverlay) likeOverlay.style.opacity = 0;
            if (nopeOverlay) nopeOverlay.style.opacity = 0;
        }
        
        // Prepare next card
        if (swipeQueue.length > 1 && nextCard) {
            const nextId = swipeQueue[1];
            const nextG = GIRLS[nextId];
            if (nextG) {
                const nextPhoto = getProfilePhoto(nextId);
                const nextImg = document.getElementById('swipeCardImgNext');
                if (nextPhoto) {
                    nextImg.innerHTML = `<img src="${nextPhoto}" alt="${nextG.name}" style="width:100%; height:100%; object-fit:cover;" loading="eager">`;
                } else {
                    nextImg.innerHTML = `<span class="swipe-initial">${INITIALS[nextId]}</span>`;
                    queuePhotoGeneration(nextId);
                }
                document.getElementById('swipeCardNameNext').textContent = nextG.name + ', ' + nextG.age;
                document.getElementById('swipeCardLocationNext').textContent = nextG.location;
                document.getElementById('swipeCardBioNext').textContent = nextG.bio;
                nextCard.style.display = 'block';
            }
        }
        
        document.getElementById('swipeButtons').style.display = 'flex';
        document.getElementById('noMoreCards').style.display = 'none';
    });
    
    // Preload more profiles in background
    preloadNextProfiles();
}

function getProfilePhoto(girlId) {
    const photos = profilePhotos[girlId];
    if (!photos) return null;
    if (Array.isArray(photos)) {
        return photos[0] || null;
    }
    return photos;
}

function getPhotoHtml(girlId, sizeClass = '') {
    const photo = getProfilePhoto(girlId);
    const initial = INITIALS[girlId];
    
    if (photo) {
        return `<div class="photo-bg ${sizeClass}" style="background-image: url('${photo}')"></div>`;
    } else if (failedPhotos[girlId]) {
        return `<div class="photo-initial ${sizeClass}">${initial}<button class="photo-retry" onclick="event.stopPropagation(); retryPhoto('${girlId}')">Reessayer</button></div>`;
    } else {
        return `<div class="photo-initial photo-loading ${sizeClass}">${initial}</div>`;
    }
}

function getAvatarHtml(girlId, size = 40) {
    const photo = getProfilePhoto(girlId);
    const initial = INITIALS[girlId];
    const style = photo ? 
        `background-image: url('${photo}'); background-size: cover; background-position: center;` : 
        `background: linear-gradient(135deg, #1a1a2e 0%, #0d0d12 100%);`;
    return `<div style="width: ${size}px; height: ${size}px; border-radius: 50%; ${style} display: flex; align-items: center; justify-content: center; font-weight: 600; color: rgba(233, 30, 99, 0.5); font-size: ${size * 0.4}px;">${photo ? '' : initial}</div>`;
}
async function generateProfilePhoto(girlId) {
    if (profilePhotos[girlId] && Array.isArray(profilePhotos[girlId]) && profilePhotos[girlId][0]) {
        return true;
    }
    
    if (!profilePhotos[girlId] || !Array.isArray(profilePhotos[girlId])) {
        profilePhotos[girlId] = [null, null, null, null, null];
    }
    
    try {
        const storedRes = await fetch('/api/stored_photos/' + girlId);
        const storedData = await storedRes.json();
        if (storedData.photos && Object.keys(storedData.photos).length > 0) {
            for (const [typeStr, url] of Object.entries(storedData.photos)) {
                const idx = parseInt(typeStr);
                if (idx >= 0 && idx < 5 && url) {
                    profilePhotos[girlId][idx] = url;
                }
            }
            localStorage.setItem('profilePhotos', JSON.stringify(profilePhotos));
            delete failedPhotos[girlId];
            localStorage.setItem('failedPhotos', JSON.stringify(failedPhotos));
            refreshAllPhotos();
            if (profilePhotos[girlId][0]) return true;
        }
    } catch (e) {
        console.log('Stored photo check failed:', e);
    }
    
    if (!profilePhotos[girlId][0]) {
        try {
            const res = await fetch('/profile_photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ girl: girlId })
            });
            
            const data = await res.json();
            
            if (data.image_url) {
                profilePhotos[girlId][0] = data.image_url;
                localStorage.setItem('profilePhotos', JSON.stringify(profilePhotos));
                delete failedPhotos[girlId];
                localStorage.setItem('failedPhotos', JSON.stringify(failedPhotos));
                refreshAllPhotos();
                return true;
            } else {
                failedPhotos[girlId] = true;
                localStorage.setItem('failedPhotos', JSON.stringify(failedPhotos));
                refreshAllPhotos();
                return false;
            }
        } catch (e) {
            console.log('Photo gen error:', girlId, e);
            failedPhotos[girlId] = true;
            localStorage.setItem('failedPhotos', JSON.stringify(failedPhotos));
            refreshAllPhotos();
            return false;
        }
    }
    return true;
}

async function processPhotoQueue() {
    if (isGeneratingPhotos || photoGenerationQueue.length === 0) return;
    isGeneratingPhotos = true;
    
    while (photoGenerationQueue.length > 0) {
        const girlId = photoGenerationQueue.shift();
        const hasPhoto = profilePhotos[girlId] && Array.isArray(profilePhotos[girlId]) && profilePhotos[girlId][0];
        if (!hasPhoto && !failedPhotos[girlId]) {
            await generateProfilePhoto(girlId);
            await new Promise(r => setTimeout(r, 500));
        }
    }
    isGeneratingPhotos = false;
}

function queuePhotoGeneration(girlId) {
    const hasPhoto = profilePhotos[girlId] && Array.isArray(profilePhotos[girlId]) && profilePhotos[girlId][0];
    if (!hasPhoto && !failedPhotos[girlId] && !photoGenerationQueue.includes(girlId)) {
        photoGenerationQueue.push(girlId);
        processPhotoQueue();
    }
}

function retryPhoto(girlId) {
    delete failedPhotos[girlId];
    localStorage.setItem('failedPhotos', JSON.stringify(failedPhotos));
    queuePhotoGeneration(girlId);
    refreshAllPhotos();
}

function refreshAllPhotos() {
    if (currentSwipeGirl) {
        const swipeImg = document.getElementById('swipeCardImg');
        if (swipeImg) {
            const g = GIRLS[currentSwipeGirl];
            const photo = getProfilePhoto(currentSwipeGirl);
            if (photo) {
                swipeImg.innerHTML = `<img src="${photo}" alt="${g.name}" style="width:100%; height:100%; object-fit:cover;">`;
                swipeImg.classList.remove('photo-loading');
            } else if (failedPhotos[currentSwipeGirl]) {
                const retryBtn = `<button class="photo-retry" onclick="event.stopPropagation(); retryPhoto('${currentSwipeGirl}')">Reessayer</button>`;
                swipeImg.innerHTML = `<span class="swipe-initial">${INITIALS[currentSwipeGirl]}</span>${retryBtn}`;
                swipeImg.classList.remove('photo-loading');
            }
        }
    }
    
    if (currentGirl) {
        const g = GIRLS[currentGirl];
        const profilePhoto = document.getElementById('profileMainPhoto');
        if (profilePhoto) {
            const photo = getProfilePhoto(currentGirl);
            if (photo) {
                profilePhoto.innerHTML = `<img src="${photo}" alt="${g.name}" style="width:100%; height:100%; object-fit:cover; border-radius:inherit;">`;
                profilePhoto.classList.remove('photo-loading');
            } else if (failedPhotos[currentGirl]) {
                const retryBtn = `<button class="photo-retry" onclick="event.stopPropagation(); retryPhoto('${currentGirl}')">Reessayer</button>`;
                profilePhoto.innerHTML = `<span class="profile-initial">${INITIALS[currentGirl]}</span>${retryBtn}`;
                profilePhoto.classList.remove('photo-loading');
            }
        }
        
        const chatAvatar = document.getElementById('chatInitials');
        if (chatAvatar) {
            const photo = getProfilePhoto(currentGirl);
            if (photo) {
                chatAvatar.innerHTML = `<img src="${photo}" alt="${g.name}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
            }
        }
    }
    
    renderMatches();
    renderMessagesList();
}

function initProfilePhotos() {
    if (swipeQueue.length > 0 && !profilePhotos[swipeQueue[0]]) {
        queuePhotoGeneration(swipeQueue[0]);
    }
}

let audioContext = null;

function initAudio() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
}

document.addEventListener('click', initAudio, { once: true });
document.addEventListener('touchstart', initAudio, { once: true });

function playSound(type) {
    if (!audioContext) return;
    try {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        if (type === 'match') {
            osc.frequency.setValueAtTime(523.25, audioContext.currentTime);
            osc.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
            osc.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
            osc.start(); osc.stop(audioContext.currentTime + 0.4);
        } else if (type === 'message') {
            osc.frequency.setValueAtTime(880, audioContext.currentTime);
            osc.frequency.setValueAtTime(1046.5, audioContext.currentTime + 0.05);
            gain.gain.setValueAtTime(0.2, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            osc.start(); osc.stop(audioContext.currentTime + 0.15);
        } else if (type === 'send') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, audioContext.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
            gain.gain.setValueAtTime(0.15, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            osc.start(); osc.stop(audioContext.currentTime + 0.1);
        }
    } catch(e) { console.log('Sound error:', e); }
}

function applyTheme() {
    if (darkMode) {
        document.body.classList.remove('light-theme');
    } else {
        document.body.classList.add('light-theme');
    }
    const toggle = document.getElementById('themeToggle');
    if (toggle) toggle.classList.toggle('active', darkMode);
}

const lazyImageObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
                img.src = img.dataset.src;
                img.onload = () => img.classList.add('loaded');
                img.onerror = () => img.classList.add('loaded');
                lazyImageObserver.unobserve(img);
            }
        }
    });
}, { rootMargin: '100px' });

function toggleTheme() {
    darkMode = !darkMode;
    localStorage.setItem('darkMode', darkMode);
    applyTheme();
}

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW error:', err));
}

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (!localStorage.getItem('pwaInstallDismissed')) {
        document.getElementById('installBanner').style.display = 'flex';
    }
});

function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(result => {
            deferredPrompt = null;
            hideInstallBanner();
        });
    }
}

function hideInstallBanner() {
    document.getElementById('installBanner').style.display = 'none';
    localStorage.setItem('pwaInstallDismissed', 'true');
}

function setAgeFilter(filter) {
    currentAgeFilter = filter;
    document.querySelectorAll('.filter-row:first-child .filter-btn').forEach(btn => btn.classList.remove('active'));
    if (filter === 'all') document.getElementById('filterAgeAll').classList.add('active');
    else if (filter === '18-25') document.getElementById('filterAge1825').classList.add('active');
    else if (filter === '25-35') document.getElementById('filterAge2535').classList.add('active');
    else if (filter === '35-45') document.getElementById('filterAge3545').classList.add('active');
    else if (filter === '45+') document.getElementById('filterAge45').classList.add('active');
    initSwipe();
}

function setRegionFilter(filter) {
    currentRegionFilter = filter;
    document.querySelectorAll('.filter-row:last-child .filter-btn').forEach(btn => btn.classList.remove('active'));
    const idMap = {
        all: 'filterRegionAll', france: 'filterFrance', usa: 'filterUSA', bresil: 'filterBresil',
        japon: 'filterJapon', chine: 'filterChine', thailande: 'filterThailande', indonesie: 'filterIndonesie',
        russie: 'filterRussie', moyen_orient: 'filterMoyenOrient', maghreb: 'filterMaghreb',
        afrique: 'filterAfrique', europe: 'filterEurope', amerique_latine: 'filterAmeriqueLat', asie: 'filterAsie'
    };
    const el = document.getElementById(idMap[filter]);
    if (el) el.classList.add('active');
    initSwipe();
}

function matchesAgeFilter(girl) {
    if (currentAgeFilter === 'all') return true;
    const age = girl.age;
    if (currentAgeFilter === '18-25') return age >= 18 && age <= 25;
    if (currentAgeFilter === '25-35') return age > 25 && age <= 35;
    if (currentAgeFilter === '35-45') return age > 35 && age <= 45;
    if (currentAgeFilter === '45+') return age > 45;
    return true;
}

function matchesRegionFilter(girl) {
    if (currentRegionFilter === 'all') return true;
    const loc = girl.location || '';
    const regions = REGION_MAP[currentRegionFilter] || [];
    return regions.some(r => loc.toLowerCase().includes(r.toLowerCase()));
}

function updateMessageBadge() {
    let count = Object.values(unreadMessages).reduce((a, b) => a + b, 0);
    const badge = document.getElementById('msgBadge');
    if (count > 0) {
        badge.textContent = count > 9 ? '9+' : count;
        badge.classList.add('show');
    } else {
        badge.classList.remove('show');
    }
}

function addUnreadMessage(girlId) {
    unreadMessages[girlId] = (unreadMessages[girlId] || 0) + 1;
    localStorage.setItem('unreadMessages', JSON.stringify(unreadMessages));
    updateMessageBadge();
}

function clearUnreadMessages(girlId) {
    delete unreadMessages[girlId];
    localStorage.setItem('unreadMessages', JSON.stringify(unreadMessages));
    updateMessageBadge();
}

function openChatMenu() {
    document.getElementById('chatMenu').classList.add('show');
}

function closeChatMenu() {
    document.getElementById('chatMenu').classList.remove('show');
}

function showConfirmPopup(action) {
    closeChatMenu();
    pendingConfirmAction = action;
    const titles = { unmatch: 'Unmatch', block: 'Bloquer', report: 'Signaler' };
    const texts = {
        unmatch: 'Tu ne pourras plus lui parler. Continuer?',
        block: 'Elle ne pourra plus te contacter. Continuer?',
        report: 'Signaler ce profil pour comportement inapproprie?'
    };
    document.getElementById('confirmTitle').textContent = titles[action];
    document.getElementById('confirmText').textContent = texts[action];
    document.getElementById('confirmPopup').classList.add('show');
}

function closeConfirmPopup() {
    document.getElementById('confirmPopup').classList.remove('show');
    pendingConfirmAction = null;
}

function confirmAction() {
    if (!pendingConfirmAction || !currentGirl) return;
    
    if (pendingConfirmAction === 'unmatch' || pendingConfirmAction === 'block') {
        matches = matches.filter(id => id !== currentGirl);
        localStorage.setItem('dreamMatches', JSON.stringify(matches));
        delete chatHistory[currentGirl];
        localStorage.removeItem('chat_' + currentGirl);
        
        if (pendingConfirmAction === 'block') {
            blocked.push(currentGirl);
            localStorage.setItem('dreamBlocked', JSON.stringify(blocked));
        }
        
        showToast(pendingConfirmAction === 'block' ? 'Profil bloque' : 'Unmatch effectue');
        closeConfirmPopup();
        navigateTo('matches');
    } else if (pendingConfirmAction === 'report') {
        showToast('Merci pour ton signalement');
        closeConfirmPopup();
    }
}

function showPremiumPopup() {
    document.getElementById('premiumPopup').classList.add('show');
}

function closePremiumPopup() {
    document.getElementById('premiumPopup').classList.remove('show');
}

function sendIcebreaker(text) {
    document.getElementById('chatInput').value = text;
    sendMessage();
    document.getElementById('icebreakers').style.display = 'none';
}

async function checkLogin() {
    try {
        const res = await fetch('/api/me');
        const data = await res.json();
        if (data.logged_in && data.user) {
            user = { name: data.user.username, age: data.user.age, id: data.user.id };
            localStorage.setItem('dreamUser', JSON.stringify(user));
            document.getElementById('headerUserName').textContent = user.name;
            document.getElementById('bottomNav').style.display = 'flex';
            await loadUserData();
            navigateTo('discover');
            initSwipe();
            updateSettingsPage();
        }
    } catch(e) {
        console.log('Check login error:', e);
    }
}

function showAuthTab(tab) {
    document.getElementById('formLogin').style.display = tab === 'login' ? 'flex' : 'none';
    document.getElementById('formRegister').style.display = tab === 'register' ? 'flex' : 'none';
    document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
    document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
    document.getElementById('loginError').textContent = '';
    document.getElementById('registerError').textContent = '';
}

async function doLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        document.getElementById('loginError').textContent = 'Remplis tous les champs';
        return;
    }
    
    try {
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        
        if (data.success) {
            user = { name: data.user.username, age: data.user.age, id: data.user.id };
            localStorage.setItem('dreamUser', JSON.stringify(user));
            document.getElementById('headerUserName').textContent = user.name;
            document.getElementById('bottomNav').style.display = 'flex';
            await loadUserData();
            navigateTo('discover');
            initSwipe();
            updateSettingsPage();
        } else {
            document.getElementById('loginError').textContent = data.error || 'Erreur de connexion';
        }
    } catch(e) {
        document.getElementById('loginError').textContent = 'Erreur reseau';
    }
}

function previewPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('photoPreview').innerHTML = `<img src="${e.target.result}" alt="Photo">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function showForgotPassword() {
    alert('Pour reinitialiser ton mot de passe, contacte le support.');
}

async function doRegister() {
    const username = document.getElementById('regUsername').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    const age = parseInt(document.getElementById('regAge').value);
    
    if (!username || !email || !password || !age) {
        document.getElementById('registerError').textContent = 'Remplis tous les champs';
        return;
    }
    
    if (password.length < 6) {
        document.getElementById('registerError').textContent = 'Mot de passe trop court (min 6 caracteres)';
        return;
    }
    
    if (age < 18) {
        document.getElementById('registerError').textContent = 'Tu dois avoir 18 ans ou plus';
        return;
    }
    
    try {
        const res = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password, age })
        });
        const data = await res.json();
        
        if (data.success) {
            user = { name: data.user.username, age: data.user.age, id: data.user.id };
            localStorage.setItem('dreamUser', JSON.stringify(user));
            document.getElementById('headerUserName').textContent = user.name;
            document.getElementById('bottomNav').style.display = 'flex';
            await loadUserData();
            navigateTo('discover');
            initSwipe();
            updateSettingsPage();
        } else {
            document.getElementById('registerError').textContent = data.error || 'Erreur inscription';
        }
    } catch(e) {
        document.getElementById('registerError').textContent = 'Erreur reseau';
    }
}

async function loadUserData() {
    isDataReady = false;
    try {
        matches = [];
        passed = [];
        blocked = [];
        chatHistory = {};
        affectionLevels = {};
        receivedPhotos = {};
        failedPhotos = {};
        profilePhotos = {};
        
        const savedProfilePhotos = localStorage.getItem('profilePhotos');
        const cacheVersion = localStorage.getItem('cacheVersion');
        const CURRENT_CACHE_VERSION = '2.0'; 
        
        if (cacheVersion !== CURRENT_CACHE_VERSION) {
            console.log('Cache migration: clearing old profilePhotos for 5-photo system');
            localStorage.removeItem('profilePhotos');
            localStorage.setItem('cacheVersion', CURRENT_CACHE_VERSION);
            profilePhotos = {};
        } else if (savedProfilePhotos) {
            try { 
                profilePhotos = JSON.parse(savedProfilePhotos);
                for (const girlId in profilePhotos) {
                    if (!Array.isArray(profilePhotos[girlId])) {
                        console.log('Old photo format detected, resetting');
                        profilePhotos = {};
                        localStorage.removeItem('profilePhotos');
                        break;
                    }
                }
            } catch(e) {
                profilePhotos = {};
            }
        }
        
        const [matchesRes, photosRes, discoveredRes] = await Promise.all([
            fetch('/api/matches'),
            fetch('/api/received_photos'),
            fetch('/api/discovered')
        ]);
        
        const matchesData = await matchesRes.json();
        if (matchesData.matches) {
            matches = matchesData.matches.map(m => m.girl_id);
            matchesData.matches.forEach(m => {
                affectionLevels[m.girl_id] = m.affection || 20;
            });
            localStorage.setItem('dreamMatches', JSON.stringify(matches));
            localStorage.setItem('affectionLevels', JSON.stringify(affectionLevels));
        }
        
        const photosData = await photosRes.json();
        if (photosData.photos) {
            receivedPhotos = photosData.photos;
            localStorage.setItem('receivedPhotos', JSON.stringify(receivedPhotos));
        }
        
        const discoveredData = await discoveredRes.json();
        if (discoveredData.discovered) {
            discoveredData.discovered.forEach(d => {
                if (d.action === 'passed' && !passed.includes(d.girl_id)) {
                    passed.push(d.girl_id);
                }
            });
            localStorage.setItem('dreamPassed', JSON.stringify(passed));
        }
        
        for (const girlId of matches) {
            ensureGirlContext(girlId);
            const chatRes = await fetch('/api/chat/' + girlId);
            const chatData = await chatRes.json();
            if (chatData.messages && chatData.messages.length > 0) {
                chatHistory[girlId] = chatData.messages;
                localStorage.setItem('chat_' + girlId, JSON.stringify(chatData.messages));
            }
        }
        
        localStorage.setItem('failedPhotos', JSON.stringify({}));
        isDataReady = true;
    } catch(e) {
        console.log('Load user data error:', e);
        isDataReady = true;
    }
}

async function doLogout() {
    try {
        await fetch('/api/logout', { method: 'POST' });
    } catch(e) {}
    user = null;
    matches = [];
    passed = [];
    chatHistory = {};
    affectionLevels = {};
    receivedPhotos = {};
    localStorage.clear();
    location.reload();
}

function navigateTo(page) {
    lastNavTab = page;
    
    const pageMap = {
        'discover': 'pageDiscover',
        'messages': 'pageMessages',
        'matches': 'pageMatches',
        'gallery': 'pageGallery',
        'settings': 'pageSettings'
    };
    
    const currentPage = document.querySelector('.page.active');
    const newPageEl = document.getElementById(pageMap[page]);
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navEl = document.getElementById('nav' + page.charAt(0).toUpperCase() + page.slice(1));
    if (navEl) navEl.classList.add('active');
    
    if (currentPage === newPageEl) return;
    
    if (currentPage && currentPage !== newPageEl) {
        currentPage.classList.add('page-exit');
        setTimeout(() => {
            currentPage.classList.remove('active', 'page-exit', 'page-enter');
        }, 200);
    }
    
    if (navigator.vibrate) navigator.vibrate(10);
    
    setTimeout(() => {
        document.querySelectorAll('.page').forEach(p => {
            if (p !== newPageEl) p.classList.remove('active', 'page-enter');
        });
        if (newPageEl) {
            newPageEl.classList.add('active', 'page-enter');
        }
        
        document.getElementById('bottomNav').style.display = 'flex';
        
        if (page === 'matches') renderMatches();
        if (page === 'messages') renderMessagesList();
        if (page === 'gallery') renderGallery();
        if (page === 'settings') updateSettingsPage();
    }, currentPage && currentPage !== newPageEl ? 100 : 0);
}
function renderMessagesList() {
    const list = document.getElementById('messagesList');
    const noMsg = document.getElementById('noMessagesText');
    
    const chatsWithMessages = matches.filter(id => {
        const chat = chatHistory[id] || loadChatHistory(id);
        return chat && chat.length > 0;
    });
    
    if (chatsWithMessages.length === 0) {
        list.innerHTML = '';
        noMsg.style.display = 'block';
        return;
    }
    
    noMsg.style.display = 'none';
    list.innerHTML = chatsWithMessages.map(id => {
        const g = GIRLS[id];
        const chat = chatHistory[id] || [];
        const lastMsg = chat[chat.length - 1];
        const preview = lastMsg ? (lastMsg.content.substring(0, 40) + (lastMsg.content.length > 40 ? '...' : '')) : 'Nouvelle conversation';
        const time = lastMsg ? lastMsg.time : '';
        const photo = getProfilePhoto(id);
        const avatarContent = photo ? 
            `<img src="${photo}" alt="${g.name}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">` : 
            `<span class="msg-initial">${INITIALS[id]}</span>`;
        return `
            <div class="message-item" onclick="openChatDirectly('${id}')">
                <div class="message-avatar">${avatarContent}</div>
                <div class="message-info">
                    <div class="message-name">${g.name}</div>
                    <div class="message-preview">${preview}</div>
                </div>
                <div class="message-time">${time}</div>
            </div>
        `;
    }).join('');
}

function openChatDirectly(girlId) {
    currentGirl = girlId;
    if (!chatHistory[girlId]) chatHistory[girlId] = loadChatHistory(girlId);
    const g = GIRLS[girlId];
    document.getElementById('chatName').textContent = g.name;
    const chatAvatar = document.getElementById('chatInitials');
    const photo = getProfilePhoto(girlId);
    if (photo) {
        chatAvatar.innerHTML = `<img src="${photo}" alt="${g.name}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
    } else {
        chatAvatar.innerHTML = `<span>${INITIALS[girlId]}</span>`;
    }
    renderMessages();
    showPage('chat');
}

function renderGallery() {
    const gallery = document.getElementById('photosGallery');
    const noPhotos = document.getElementById('noPhotosText');
    
    let totalPhotos = 0;
    let html = '<h2>Photos Recues</h2>';
    
    Object.keys(receivedPhotos).forEach(girlId => {
        const photos = receivedPhotos[girlId];
        if (photos && photos.length > 0) {
            totalPhotos += photos.length;
            const g = GIRLS[girlId];
            html += `
                <div class="gallery-section">
                    <div class="gallery-section-title">${g.name} - ${photos.length} photo${photos.length > 1 ? 's' : ''}</div>
                    <div class="photos-grid">
                        ${photos.map((url, i) => `
                            <div class="gallery-photo" onclick="openGalleryPhoto('${girlId}', ${i})">
                                <img src="${url}" alt="" loading="lazy">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    if (totalPhotos === 0) {
        gallery.innerHTML = '';
        noPhotos.style.display = 'block';
    } else {
        noPhotos.style.display = 'none';
        gallery.innerHTML = html;
    }
}

function openGalleryPhoto(girlId, index) {
    currentOverlayPhotos = receivedPhotos[girlId] || [];
    currentOverlayIndex = index;
    updateOverlay();
    document.getElementById('img-overlay').style.display = 'flex';
}

function updateSettingsPage() {
    if (!user) return;
    document.getElementById('settingsAvatar').textContent = user.name.charAt(0).toUpperCase();
    document.getElementById('settingsName').textContent = user.name;
    document.getElementById('settingsAge').textContent = user.age + ' ans';
    document.getElementById('statsMatches').textContent = matches.length;
    
    let photoCount = 0;
    Object.values(receivedPhotos).forEach(arr => { photoCount += (arr || []).length; });
    document.getElementById('statsPhotos').textContent = photoCount;
    
    let chatCount = 0;
    matches.forEach(id => {
        const chat = chatHistory[id] || loadChatHistory(id);
        if (chat && chat.length > 0) chatCount++;
    });
    document.getElementById('statsChats').textContent = chatCount;
}

function logout() {
    doLogout();
}

function resetAllData() {
    if (confirm('Effacer toutes les donnees? Cette action est irreversible.')) {
        localStorage.clear();
        location.reload();
    }
}

function initSwipe() {
    const seenIds = new Set([...matches, ...passed, ...blocked]);
    
    swipeQueue = Object.keys(GIRLS).filter(id => {
        if (seenIds.has(id)) return false;
        const g = GIRLS[id];
        if (!matchesAgeFilter(g)) return false;
        if (!matchesRegionFilter(g)) return false;
        return true;
    });
    
    swipeQueue = [...new Set(swipeQueue)];
    swipeQueue = swipeQueue.sort(() => Math.random() - 0.5);
    
    matches.forEach(id => { 
        if (!chatHistory[id]) chatHistory[id] = loadChatHistory(id);
        if (affectionLevels[id] === undefined) affectionLevels[id] = 20;
    });
    
    isProcessingSwipe = false;
    currentSwipeGirl = null;
    isDragging = false;
    
    initProfilePhotos();
    setupTouchGestures();
    showNextCardInstant();
    preloadNextProfiles();
    renderMatches();
    updateMessageBadge();
    applyTheme();
}

function showNextCard() {
    showNextCardInstant();
}

function swipeLeft() {
    if (!currentSwipeGirl || isProcessingSwipe) return;
    animateSwipe('left');
}

function resetSwipeState() {
    isProcessingSwipe = false;
    const card = document.getElementById('swipeCard');
    if (card) {
        card.style.opacity = '1';
        card.style.pointerEvents = 'auto';
    }
}

function swipeRight() {
    if (!currentSwipeGirl || isProcessingSwipe) return;
    animateSwipe('right');
}

async function syncMatch(girlId) {
    try {
        const res = await fetch('/api/matches', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ girl_id: girlId })
        });
        const data = await res.json();
        if (data.success) {
            affectionLevels[girlId] = data.affection || 20;
            localStorage.setItem('affectionLevels', JSON.stringify(affectionLevels));
            console.log('Match synced:', girlId, 'affection:', data.affection);
            generateSecretPhoto(girlId);
        } else {
            console.error('Match sync failed:', data.error);
        }
    } catch(e) { console.error('Sync match error:', e); }
}

async function generateSecretPhoto(girlId) {
    // Ensure array exists with 5 slots
    if (!profilePhotos[girlId]) profilePhotos[girlId] = [null, null, null, null, null];
    if (profilePhotos[girlId].length < 5) {
        while (profilePhotos[girlId].length < 5) profilePhotos[girlId].push(null);
    }
    
    // Skip if secret photo already exists
    if (profilePhotos[girlId][4]) return;
    
    try {
        const aff = affectionLevels[girlId] || 20;
        const photoPrompt = PHOTO_TYPES[4].getPrompt(aff);
        const res = await fetch('/photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                girl: girlId,
                affection: aff,
                description: photoPrompt,
                photo_type: 4
            })
        });
        const data = await res.json();
        
        if (data.image_url) {
            profilePhotos[girlId][4] = data.image_url;
            localStorage.setItem('profilePhotos', JSON.stringify(profilePhotos));
            console.log('Secret photo unlocked for', girlId);
        }
    } catch (e) {
        console.error('Secret photo generation error:', e);
    }
}

async function syncDiscovered(girlId, action) {
    try {
        await fetch('/api/discovered', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ girl_id: girlId, action: action })
        });
    } catch(e) { console.log('Sync discovered error:', e); }
}

async function syncAffection(girlId, delta) {
    try {
        await fetch('/api/affection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ girl_id: girlId, delta: delta })
        });
    } catch(e) { console.log('Sync affection error:', e); }
}

async function syncChatMessage(girlId, msg) {
    try {
        await fetch('/api/chat/' + girlId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sender: msg.role, content: msg.content, time: msg.time })
        });
    } catch(e) { console.log('Sync chat error:', e); }
}

async function syncReceivedPhoto(girlId, photoUrl) {
    try {
        await fetch('/api/received_photos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ girl_id: girlId, photo_url: photoUrl })
        });
    } catch(e) { console.log('Sync photo error:', e); }
}
function showMatchAnimation(girlId) {
    playSound('match');
    const g = GIRLS[girlId];
    const photo = getProfilePhoto(girlId);
    
    const mainPhoto = document.getElementById('matchGirlPhoto');
    if (photo) {
        mainPhoto.innerHTML = `<img src="${photo}" alt="${g.name}">`;
    } else {
        mainPhoto.innerHTML = `<span class="match-initial">${INITIALS[girlId]}</span>`;
    }
    
    document.getElementById('matchGirlName').textContent = g.name + ', ' + g.age;
    
    document.getElementById('matchPhotoUser').textContent = user.name.charAt(0).toUpperCase();
    
    const girlPhotoSmall = document.getElementById('matchPhotoGirl');
    if (photo) {
        girlPhotoSmall.innerHTML = `<img src="${photo}" alt="${g.name}">`;
    } else {
        girlPhotoSmall.textContent = INITIALS[girlId];
    }
    
    
    const heartsDiv = document.getElementById('hearts');
    heartsDiv.innerHTML = '';
    for (let i = 0; i < 20; i++) {
        const heart = document.createElement('div');
        heart.className = 'heart';
        heart.textContent = 'â™¥';
        heart.style.left = Math.random() * 100 + '%';
        heart.style.animationDelay = Math.random() * 2 + 's';
        heart.style.color = '#e91e63';
        heartsDiv.appendChild(heart);
    }
    
    document.getElementById('matchOverlay').style.display = 'flex';
    girlMessagesFirst(girlId);
}

function showNoMatch() {
    const msg = document.getElementById('noMatchMsg');
    msg.style.display = 'block';
    setTimeout(() => {
        msg.style.display = 'none';
        resetSwipeState();
        isProcessingSwipe = false;
        showNextCardInstant();
    }, 1500);
}

function closeMatch() {
    document.getElementById('matchOverlay').style.display = 'none';
    resetSwipeState();
    renderMatches();
    isProcessingSwipe = false;
    showNextCardInstant();
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const overlay = document.getElementById('matchOverlay');
        if (overlay && overlay.style.display === 'flex') {
            closeMatch();
        }
    }
});

function showHeartBurst(x, y) {
    const heart = document.createElement('div');
    heart.className = 'heart-burst';
    heart.textContent = 'â¤ï¸';
    heart.style.left = x + 'px';
    heart.style.top = y + 'px';
    document.body.appendChild(heart);
    setTimeout(() => heart.remove(), 600);
}

function showTapFlash() {
    const flash = document.createElement('div');
    flash.className = 'tap-flash';
    document.body.appendChild(flash);
    setTimeout(() => flash.remove(), 150);
}

let lastTapTime = 0;
function handleDoubleTap(e, callback) {
    const currentTime = Date.now();
    const tapLength = currentTime - lastTapTime;
    if (tapLength < 300 && tapLength > 0) {
        callback(e);
    }
    lastTapTime = currentTime;
}

function doubleTapLike(e) {
    showHeartBurst(e.clientX || window.innerWidth/2, e.clientY || window.innerHeight/2);
    swipeRight();
}

function goToMatchChat() {
    document.getElementById('matchOverlay').style.display = 'none';
    const lastMatch = matches[matches.length - 1];
    showProfile(lastMatch);
    renderMatches();
}

function renderMatches() {
    const list = document.getElementById('matchesList');
    const countEl = document.getElementById('matchesCount');
    
    if (matches.length === 0) {
        list.style.display = 'none';
        document.getElementById('noMatches').style.display = 'block';
        if (countEl) countEl.textContent = '';
        return;
    }
    
    list.style.display = 'flex';
    document.getElementById('noMatches').style.display = 'none';
    if (countEl) countEl.textContent = matches.length + ' matchs';
    
    list.innerHTML = matches.filter(id => GIRLS[id]).map(id => {
        const g = GIRLS[id];
        const photo = getProfilePhoto(id);
        const initial = g.name ? g.name[0].toUpperCase() : '?';
        const avatarContent = photo ? 
            `<img src="${photo}" alt="${g.name}">` : initial;
        
        const chatHistory = JSON.parse(localStorage.getItem('chat_' + id) || '[]');
        const lastMsg = chatHistory.length > 0 ? chatHistory[chatHistory.length - 1] : null;
        const preview = lastMsg ? (lastMsg.sender === 'user' ? 'Toi: ' : '') + lastMsg.content.substring(0, 40) + '...' : 'Commence la conversation...';
        const timeAgo = lastMsg ? getTimeAgo(lastMsg.time) : '';
        
        const affection = parseInt(affectionLevels[id]) || 20;
        
        return `
            <div class="match-item" onclick="showProfile('${id}')">
                <div class="match-item-avatar">${avatarContent}</div>
                <div class="match-item-info">
                    <div class="match-item-name">${g.name}, ${g.age} <span class="match-item-online"></span></div>
                    <div class="match-item-preview">${preview}</div>
                    <div class="match-item-time">${timeAgo}</div>
                </div>
                <div class="match-item-actions">
                    <button class="match-action-btn match-action-chat" onclick="event.stopPropagation(); quickChat('${id}')">ðŸ’¬</button>
                </div>
            </div>
        `;
    }).join('');
}

function getTimeAgo(timeStr) {
    if (!timeStr) return '';
    const now = new Date();
    const then = new Date(timeStr);
    const diff = Math.floor((now - then) / 1000 / 60);
    if (diff < 1) return 'A l\'instant';
    if (diff < 60) return diff + ' min';
    if (diff < 1440) return Math.floor(diff/60) + 'h';
    return Math.floor(diff/1440) + 'j';
}

function quickChat(girlId) {
    currentGirl = girlId;
    const g = GIRLS[girlId];
    if (!g) return;
    
    document.getElementById('chatName').textContent = g.name;
    
    const chatAvatar = document.getElementById('chatInitials');
    const photo = getProfilePhoto(girlId);
    if (photo) {
        chatAvatar.innerHTML = `<img src="${photo}" alt="${g.name}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
    } else {
        chatAvatar.innerHTML = `<span>${INITIALS[girlId]}</span>`;
    }
    
    if (!chatHistory[girlId]) chatHistory[girlId] = loadChatHistory(girlId);
    renderMessages();
    showPage('chat');
}

function init() {
    checkLogin();
}

let lastNavTab = 'discover';

function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const pageId = 'page' + page.charAt(0).toUpperCase() + page.slice(1);
    const pageEl = document.getElementById(pageId);
    if (pageEl) pageEl.classList.add('active');
    
    const bottomNav = document.getElementById('bottomNav');
    if (bottomNav) {
        if (['profile', 'chat'].includes(page)) {
            bottomNav.style.display = 'none';
        } else {
            bottomNav.style.display = 'flex';
        }
    }
}

function goBackFromProfile() {
    navigateTo(lastNavTab);
}

function goBackFromChat() {
    showPage('profile');
}

function showProfile(id) {
    if (!matches.includes(id)) {
        showToast("Tu dois d'abord matcher avec elle!");
        return;
    }
    if (!GIRLS[id]) {
        showToast("Profil non disponible");
        return;
    }
    currentGirl = id;
    const g = GIRLS[id];
    document.getElementById('profileName').textContent = g.name + ', ' + g.age;
    document.getElementById('profileTagline').textContent = g.tagline;
    document.getElementById('profileBio').textContent = g.bio || '';
    const affection = parseInt(affectionLevels[id]) || 20;
    document.getElementById('profileAffection').textContent = affection + '%';
    
    const profilePhoto = document.getElementById('profileMainPhoto');
    const photo = getProfilePhoto(id);
    if (photo) {
        profilePhoto.innerHTML = `<img src="${photo}" alt="${g.name}" style="width:100%; height:100%; object-fit:cover; border-radius:inherit;">`;
        profilePhoto.classList.remove('photo-loading');
    } else {
        const retryBtn = failedPhotos[id] ? `<button class="photo-retry" onclick="event.stopPropagation(); retryPhoto('${id}')">Reessayer</button>` : '';
        profilePhoto.innerHTML = `<span class="profile-initial">${INITIALS[id] || '?'}</span>${retryBtn}`;
        if (!failedPhotos[id]) {
            profilePhoto.classList.add('photo-loading');
        } else {
            profilePhoto.classList.remove('photo-loading');
        }
    }
    loadProfilePhotos(id);
    
    showPage('profile');
}

function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 2000);
}

async function loadProfilePhotos(girlId) {
    const grid = document.getElementById('profilePhotoGrid');
    const mainPhoto = document.getElementById('profileMainPhoto');
    const g = GIRLS[girlId];
    const isMatched = matches.includes(girlId);
    
    if (!profilePhotos[girlId]) profilePhotos[girlId] = [null, null, null, null, null];
    while (profilePhotos[girlId].length < 5) profilePhotos[girlId].push(null);
    
    try {
        const storedRes = await fetch('/api/stored_photos/' + girlId);
        const storedData = await storedRes.json();
        if (storedData.photos && Object.keys(storedData.photos).length > 0) {
            for (const [typeStr, url] of Object.entries(storedData.photos)) {
                const idx = parseInt(typeStr);
                if (idx >= 0 && idx < 5 && url) {
                    profilePhotos[girlId][idx] = url;
                }
            }
            localStorage.setItem('profilePhotos', JSON.stringify(profilePhotos));
        }
    } catch (e) {
        console.log('Stored photos check failed:', e);
    }
    
    const regularPhotosReady = profilePhotos[girlId].slice(0, 4).filter(p => p).length === 4;
    if (regularPhotosReady) {
        if (isMatched && !profilePhotos[girlId][4]) {
            generateSecretPhoto(girlId);
        }
        renderProfilePhotos(girlId);
        return;
    }
    
    const photoLabels = ['Portrait', 'Exterieur', 'Sexy', 'Lingerie', 'Secret'];
    mainPhoto.innerHTML = '<div class="photo-loading"><div class="spinner"></div><span>Chargement...</span></div>';
    mainPhoto.style.fontSize = '1rem';
    
    grid.innerHTML = photoLabels.map((label, i) => {
        if (i === 4 && !isMatched) {
            return `<div class="photo-grid-item photo-locked"><span class="lock-icon">ðŸ”’</span><span>Photo privee</span></div>`;
        }
        return `<div class="photo-grid-item"><div class="photo-loading"><div class="spinner"></div><span>${label}</span></div></div>`;
    }).join('');
    
    const aff = affectionLevels[girlId] || 20;
    
    for (let i = 0; i < 4; i++) {
        if (profilePhotos[girlId][i]) {
            renderProfilePhotos(girlId);
            continue;
        }
        
        if (currentGirl !== girlId) return;
        
        try {
            const photoPrompt = PHOTO_TYPES[i].getPrompt(aff);
            const res = await fetch('/photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    girl: girlId,
                    affection: aff,
                    description: photoPrompt,
                    photo_type: i
                })
            });
            const data = await res.json();
            
            if (currentGirl !== girlId) return;
            
            if (data.image_url) {
                profilePhotos[girlId][i] = data.image_url;
                localStorage.setItem('profilePhotos', JSON.stringify(profilePhotos));
                renderProfilePhotos(girlId);
            }
        } catch (e) {
            console.error('Photo generation error:', e);
        }
    }
    
    if (isMatched && !profilePhotos[girlId][4]) {
        generateSecretPhoto(girlId);
    }
}

function renderProfilePhotos(girlId) {
    if (currentGirl !== girlId) return;
    
    const grid = document.getElementById('profilePhotoGrid');
    const mainPhoto = document.getElementById('profileMainPhoto');
    const photos = profilePhotos[girlId] || [];
    const isMatched = matches.includes(girlId);
    
    if (photos[0]) {
        mainPhoto.innerHTML = `<img src="${photos[0]}" style="width:100%;height:100%;object-fit:cover;">`;
        mainPhoto.style.fontSize = '';
    } else {
        mainPhoto.textContent = INITIALS[girlId];
    }
    
    const labels = ['Portrait', 'Exterieur', 'Sexy', 'Lingerie', 'Secret'];
    grid.innerHTML = labels.map((label, i) => {
        if (i === 4) {
            if (!isMatched) {
                return `<div class="photo-grid-item photo-locked"><span class="lock-icon">ðŸ”’</span><span>Photo privee</span></div>`;
            } else if (photos[i]) {
                return `<div class="photo-grid-item secret-unlocked" onclick="openGallery('${girlId}', ${i})"><img src="${photos[i]}" alt="${label}"><span class="unlock-badge">ðŸ”“ðŸ”¥</span></div>`;
            } else {
                return `<div class="photo-grid-item"><div class="photo-loading"><div class="spinner"></div><span>Deverrouillage...</span></div></div>`;
            }
        }
        
        if (photos[i]) {
            return `<div class="photo-grid-item" onclick="openGallery('${girlId}', ${i})"><img src="${photos[i]}" alt="${label}"></div>`;
        } else {
            return `<div class="photo-grid-item"><div class="photo-loading"><div class="spinner"></div><span>${label}</span></div></div>`;
        }
    }).join('');
}

function openGallery(girlId, index) {
    currentOverlayPhotos = profilePhotos[girlId] || [];
    currentOverlayIndex = index;
    updateOverlay();
    document.getElementById('img-overlay').style.display = 'flex';
}

function updateOverlay() {
    if (currentOverlayPhotos.length === 0) return;
    document.getElementById('overlay-img').src = currentOverlayPhotos[currentOverlayIndex];
    document.getElementById('overlay-counter').textContent = (currentOverlayIndex + 1) + ' / ' + currentOverlayPhotos.length;
}

function prevOverlayImg() {
    if (currentOverlayPhotos.length === 0) return;
    currentOverlayIndex = (currentOverlayIndex - 1 + currentOverlayPhotos.length) % currentOverlayPhotos.length;
    updateOverlay();
}

function nextOverlayImg() {
    if (currentOverlayPhotos.length === 0) return;
    currentOverlayIndex = (currentOverlayIndex + 1) % currentOverlayPhotos.length;
    updateOverlay();
}

function showVideoToast() {
    showToast('BientÃ´t disponible');
}

let storyPhotos = [];
let storyIndex = 0;
let storyTimer = null;

const STORY_TEXTS = [
    "Coucou c'est moi",
    "Ma journee en photos",
    "Qu'est-ce que tu en penses?",
    "Tu me manques..."
];

function openStories() {
    if (!currentGirl || !isDataReady) {
        showToast("Chargement en cours...");
        return;
    }
    ensureGirlContext(currentGirl);
    const photos = profilePhotos[currentGirl] || [];
    if (photos.filter(p => p).length === 0) {
        showToast("Pas encore de photos disponibles");
        return;
    }
    storyPhotos = photos.filter(p => p);
    storyIndex = 0;
    
    const progressDiv = document.getElementById('storyProgress');
    progressDiv.innerHTML = storyPhotos.map((_, i) => `<div class="story-bar"><div class="story-bar-fill" id="bar${i}"></div></div>`).join('');
    
    document.getElementById('storyOverlay').style.display = 'flex';
    showStory();
}

function showStory() {
    if (storyIndex >= storyPhotos.length) {
        closeStories();
        return;
    }
    document.getElementById('storyImg').src = storyPhotos[storyIndex];
    document.getElementById('storyText').textContent = STORY_TEXTS[storyIndex % STORY_TEXTS.length];
    
    for (let i = 0; i < storyPhotos.length; i++) {
        const bar = document.getElementById('bar' + i);
        if (bar) {
            bar.style.transition = 'none';
            bar.style.width = i < storyIndex ? '100%' : '0%';
        }
    }
    
    const currentBar = document.getElementById('bar' + storyIndex);
    if (currentBar) {
        setTimeout(() => {
            currentBar.style.transition = 'width 5s linear';
            currentBar.style.width = '100%';
        }, 50);
    }
    
    clearTimeout(storyTimer);
    storyTimer = setTimeout(() => {
        storyIndex++;
        showStory();
    }, 5000);
}

function nextStory() {
    storyIndex++;
    showStory();
}

function prevStory() {
    if (storyIndex > 0) storyIndex--;
    showStory();
}

function closeStories() {
    clearTimeout(storyTimer);
    document.getElementById('storyOverlay').style.display = 'none';
}

function startChat() {
    console.log("Tentative ouverture chat pour:", currentGirl);
    
    // 1. On force l'ouverture de la page immÃ©diatement (on supprime la condition bloquante)
    showPage('chat');
    
    // 2. SÃ©curitÃ© basique
    if (!currentGirl) return;

    // 3. RÃ©cupÃ©ration des infos (avec roue de secours si Ã§a bug)
    var g = GIRLS[currentGirl];
    if (!g) {
        g = { name: "Inconnue", age: "20" }; // Profil par dÃ©faut pour Ã©viter le crash
    }

    // 4. Mise Ã  jour du nom
    var nameEl = document.getElementById('chatName');
    if (nameEl) nameEl.textContent = g.name;
    
    // 5. Mise Ã  jour de l'avatar (Version simple pour Ã©viter les bugs d'image)
    var chatAvatar = document.getElementById('chatInitials');
    if (chatAvatar) {
        chatAvatar.style.backgroundImage = 'none'; 
        chatAvatar.textContent = (g.name || "?").charAt(0);
    }
    
    // 6. Initialisation de l'historique
    if (typeof chatHistory !== 'undefined') {
        if (!chatHistory[currentGirl]) chatHistory[currentGirl] = [];
        renderMessages();
    }
    
    // 7. Focus clavier
    setTimeout(function() {
        var input = document.getElementById('chatInput');
        if (input) input.focus();
    }, 100);
}


function getTime() {
    const now = new Date();
    return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
}

function renderMessages() {
    const msgs = chatHistory[currentGirl];
    const container = document.getElementById('messages');
    
    if (msgs.length === 0) {
        container.innerHTML = '<div class="empty-chat">DÃ‰BUT DE LA CONVERSATION</div>';
        return;
    }
    
    container.innerHTML = msgs.map(m => {
        const cls = m.role === 'user' ? 'user' : 'her';
        const text = (m.content || '').replace(/\[PHOTO:[^\]]+\]/g, '').trim();
        const imgHtml = m.image ? `<div class="msg-img" onclick="fullscreenImg('${m.image}')"><img class="lazy-load" data-src="${m.image}" src="${m.image}" alt="Photo" onload="this.classList.add('loaded')"></div>` : '';
        const receipt = m.role === 'user' ? '<span class="read-receipt">âœ“âœ“</span>' : '';
        
        return `<div class="msg ${cls}">
            ${text ? `<div class="msg-bubble">${text}</div>` : ''}
            ${imgHtml}
            <div class="msg-meta">${m.time} ${receipt}</div>
        </div>`;
    }).join('');
    
    container.scrollTop = container.scrollHeight;
}

function fullscreenImg(url) {
    currentOverlayPhotos = [url];
    currentOverlayIndex = 0;
    document.getElementById('overlay-img').src = url;
    document.getElementById('overlay-counter').textContent = '1 / 1';
    document.getElementById('img-overlay').style.display = 'flex';
}

function setTyping(isTyping) {
    try {
        const el = document.getElementById('typing-indicator');
        if (!el) return;
        if (isTyping) {
            const girlName = (GIRLS[currentGirl] && GIRLS[currentGirl].name) || 'Elle';
            el.innerHTML = girlName + ' <span class="typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>';
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.gap = '8px';
        } else {
            el.style.display = 'none';
        }
    } catch(e) { console.log('setTyping error:', e); }
}

async function sendMessage() {
    console.log("[SEND] Start");
    
    // VÃ©rifications de base
    if (!currentGirl) { showToast("Aucune fille sÃ©lectionnÃ©e"); return; }
    if (!isDataReady) { showToast("Chargement en cours..."); return; }
    
    // Initialiser le contexte
    try { ensureGirlContext(currentGirl); } catch(e) { console.log("[SEND] ensureGirlContext error:", e); }
    
    const input = document.getElementById('chatInput');
    if (!input) { console.log("[SEND] No input element"); return; }
    const text = input.value.trim();
    if (!text) return;
    
    console.log("[SEND] Text:", text, "Girl:", currentGirl);
    
    // Actions UI
    try { playSound('send'); } catch(e) {}
    input.value = '';
    try { document.getElementById('sendBtn').disabled = true; } catch(e) {}
    try { document.getElementById('icebreakers').style.display = 'none'; } catch(e) {}
    try { clearUnreadMessages(currentGirl); } catch(e) {}
    
    // Calcul affection
    const lowerText = text.toLowerCase();
    let affDelta = 0;
    if (['belle', 'jolie', 'adore', 'sexy', 'magnifique', 'charme', 'parfaite', 'canon', 'plait'].some(word => lowerText.includes(word))) {
        affDelta += 5;
    }
    
    let autoRequestPhoto = false;
    if (['photo', 'nude', 'montre', 'voir', 'dÃ©shabille', 'nu', 'corps', 'poitrine', 'fesse'].some(word => lowerText.includes(word))) {
        affDelta += 2;
        autoRequestPhoto = true;
    }
    
    if (affDelta > 0) {
        const currentAff = affectionLevels[currentGirl] || 20;
        affectionLevels[currentGirl] = Math.min(100, currentAff + affDelta);
        try { localStorage.setItem('affectionLevels', JSON.stringify(affectionLevels)); } catch(e) {}
        try { syncAffection(currentGirl, affDelta); } catch(e) {}
    }
    
    // Ajouter message utilisateur
    if (!chatHistory[currentGirl]) chatHistory[currentGirl] = [];
    const userMsg = { role: 'user', content: text, time: getTime() };
    chatHistory[currentGirl].push(userMsg);
    try { saveChatHistory(currentGirl); } catch(e) {}
    try { syncChatMessage(currentGirl, userMsg); } catch(e) {}
    try { renderMessages(); } catch(e) { console.log("[SEND] renderMessages error:", e); }
    
    // Typing indicator (protÃ©gÃ©)
    setTimeout(() => {
        try {
            const el = document.getElementById('typing-indicator');
            if (el) {
                const girlName = (GIRLS[currentGirl] && GIRLS[currentGirl].name) || 'Elle';
                el.innerHTML = girlName + ' <span class="typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>';
                el.style.display = 'flex';
            }
        } catch(e) { console.log("[SEND] typing error:", e); }
    }, 1500);
    
    // FETCH - Le coeur du problÃ¨me
    console.log("[SEND] Starting fetch...");
    try {
        const bodyData = {
            girl: currentGirl,
            affection: affectionLevels[currentGirl] || 20,
            auto_photo: autoRequestPhoto,
            messages: (chatHistory[currentGirl] || []).slice(-15).map(m => ({ role: m.role, content: m.content }))
        };
        console.log("[SEND] Body:", JSON.stringify(bodyData).substring(0, 200));
        
        const res = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyData)
        });
        
        console.log("[SEND] Fetch done, status:", res.status);
        
        const data = await res.json();
        console.log("[SEND] Response:", data.reply ? data.reply.substring(0, 50) : "no reply");
        
        // Cacher typing
        try {
            const el = document.getElementById('typing-indicator');
            if (el) el.style.display = 'none';
        } catch(e) {}
        
        try { playSound('message'); } catch(e) {}
        
        let reply = data.reply || "DÃ©solÃ©e, j'ai un souci technique...";
        const photoMatch = reply.match(/\[PHOTO:\s*([^\]]+)\]/i);
        const cleanReply = reply.replace(/\[PHOTO:[^\]]+\]/gi, '').trim();
        
        const msgObj = { role: 'assistant', content: cleanReply, time: getTime() };
        chatHistory[currentGirl].push(msgObj);
        try { saveChatHistory(currentGirl); } catch(e) {}
        try { syncChatMessage(currentGirl, msgObj); } catch(e) {}
        try { renderMessages(); } catch(e) {}
        
        if (photoMatch) {
            try { await generatePhoto(photoMatch[1], msgObj); } catch(e) { console.log("[SEND] photo error:", e); }
        } else if (data.smart_photo) {
            try { await generatePhoto(data.smart_photo, msgObj); } catch(e) { console.log("[SEND] smart_photo error:", e); }
        }
    } catch (e) {
        console.log("[SEND] FETCH ERROR:", e);
        try {
            const el = document.getElementById('typing-indicator');
            if (el) el.style.display = 'none';
        } catch(e2) {}
        if (!chatHistory[currentGirl]) chatHistory[currentGirl] = [];
        chatHistory[currentGirl].push({ role: 'assistant', content: "DÃ©solÃ©e, erreur rÃ©seau: " + e.message, time: getTime() });
        try { saveChatHistory(currentGirl); } catch(e2) {}
        try { renderMessages(); } catch(e2) {}
    }
    
    try { document.getElementById('sendBtn').disabled = false; } catch(e) {}
    console.log("[SEND] Done");
}

async function requestProfilePhoto() {
    if (!currentGirl || !isDataReady) {
        showToast("Chargement en cours...");
        return;
    }
    ensureGirlContext(currentGirl);
    startChat();
    const msgObj = { role: 'assistant', content: "Tiens, une photo rien que pour toi...", time: getTime(), loading: true };
    chatHistory[currentGirl].push(msgObj);
    saveChatHistory(currentGirl);
    renderMessages();
    showToast("Generation de la photo...");
    const success = await generatePhoto("casual selfie, beautiful smile, high quality", msgObj);
    msgObj.loading = false;
    if (!success) {
        msgObj.content = "Desole, la photo n'a pas pu etre generee...";
    }
    saveChatHistory(currentGirl);
    renderMessages();
}

async function generatePhoto(description, msgObj) {
    try {
        console.log("[PHOTO] Generating:", description);
        const res = await fetch('/photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                girl: currentGirl,
                affection: affectionLevels[currentGirl] || 20,
                description: description
            })
        });
        
        const data = await res.json();
        console.log("[PHOTO] Response:", data);
        if (data.image_url) {
            msgObj.image = data.image_url;
            saveReceivedPhoto(currentGirl, data.image_url);
            saveChatHistory(currentGirl);
            renderMessages();
            return true;
        } else if (data.error) {
            console.error("[PHOTO] API Error:", data.error);
            showToast("Erreur photo: " + data.error);
            return false;
        }
        return false;
    } catch (e) { 
        console.error('[PHOTO] Error:', e); 
        showToast("Erreur de generation photo");
        return false;
    }
}

document.getElementById('chatInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});

// ============ STORIES SECTION ============
async function loadStories() {
    try {
        const res = await fetch('/api/stories');
        const data = await res.json();
        renderStoriesCircles(data.stories || []);
    } catch(e) {
        console.log("Stories load error:", e);
        renderStoriesCircles([]);
    }
}

function renderStoriesCircles(stories) {
    const container = document.getElementById('storiesScroll');
    if (!container) return;
    
    const matchedGirls = Object.keys(matches).slice(0, 10);
    
    let html = '';
    matchedGirls.forEach(girlId => {
        const girl = GIRLS[girlId];
        if (!girl) return;
        const hasStory = stories.some(s => s.girl_id === girlId);
        const initial = girl.name ? girl.name[0].toUpperCase() : '?';
        
        html += `<div class="story-circle" onclick="viewStory('${girlId}')">
            <div class="story-avatar ${hasStory ? '' : 'no-story'}">
                <div class="story-avatar-inner">${initial}</div>
            </div>
            <span class="story-username">${girl.name || 'Inconnue'}</span>
        </div>`;
    });
    
    container.innerHTML = html || '<p style="color:#666;font-size:0.8rem;padding:0.5rem;">Match avec des filles pour voir leurs stories</p>';
}

async function viewStory(girlId) {
    const girl = GIRLS[girlId];
    if (!girl) return;
    showToast("Story de " + girl.name + " en cours...");
}

// ============ CAMGIRLS SECTION ============
let camgirlsData = [];
let currentCamgirl = null;

async function loadCamgirls() {
    try {
        const res = await fetch('/api/camgirls');
        const data = await res.json();
        camgirlsData = data.camgirls || [];
        renderCamgirls();
    } catch(e) {
        console.log("Camgirls load error:", e);
    }
}

function renderCamgirls() {
    const grid = document.getElementById('camgirlsGrid');
    if (!grid) return;
    
    let html = '';
    camgirlsData.forEach(cam => {
        const viewers = Math.floor(Math.random() * 400) + 50;
        const girl = GIRLS[cam.girl_id];
        const initial = cam.name ? cam.name[0].toUpperCase() : '?';
        const photo = getProfilePhoto(cam.girl_id);
        
        const imgContent = photo ? 
            `<img src="${photo}" alt="${cam.name}" style="width:100%;height:100%;object-fit:cover;">` :
            `<span style="font-size:3rem;color:rgba(233,30,99,0.3);">${initial}</span>`;
        
        html += `<div class="camgirl-card" onclick="openCamgirl('${cam.girl_id}')">
            <div class="camgirl-card-img">${imgContent}</div>
            <div class="camgirl-live-badge">LIVE</div>
            <div class="camgirl-viewers">${viewers} viewers</div>
            <div class="camgirl-card-info">
                <div class="camgirl-name">${cam.name}</div>
                <div class="camgirl-tagline">${cam.tagline || ''}</div>
            </div>
        </div>`;
    });
    
    grid.innerHTML = html || '<p style="color:#666;text-align:center;padding:2rem;">Aucune camgirl en ligne</p>';
    
    camgirlsData.forEach(cam => {
        if (!getProfilePhoto(cam.girl_id)) {
            queuePhotoGeneration(cam.girl_id);
        }
    });
}

async function openCamgirl(girlId) {
    currentCamgirl = girlId;
    const cam = camgirlsData.find(c => c.girl_id === girlId);
    if (!cam) return;
    
    document.getElementById('camgirlModal').style.display = 'flex';
    document.getElementById('camgirlName').textContent = cam.name;
    document.getElementById('camgirlTagline').textContent = cam.tagline || '';
    
    const viewers = Math.floor(Math.random() * 400) + 50;
    document.getElementById('camgirlViewers').textContent = viewers + ' viewers';
    
    const initial = cam.name ? cam.name[0].toUpperCase() : '?';
    const videoDiv = document.getElementById('camgirlVideo');
    videoDiv.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:4rem;color:rgba(233,30,99,0.3);background:#0a0a0c;">${initial}</div>`;
    
    try {
        const res = await fetch('/api/camgirl_photo/' + girlId);
        const data = await res.json();
        if (data.image_url) {
            videoDiv.innerHTML = `<img src="${data.image_url}" style="width:100%;height:100%;object-fit:cover;" alt="${cam.name}">`;
        }
    } catch(e) { console.log("Cam photo error:", e); }
    
    renderTipMenu(cam.tip_menu || {});
    
    document.getElementById('camgirlChat').innerHTML = `
        <div class="cam-msg"><span class="user">System:</span> Bienvenue dans le show de ${cam.name}!</div>
        <div class="cam-msg"><span class="user">${cam.name}:</span> Coucou tout le monde!</div>
    `;
}

function renderTipMenu(tipMenu) {
    const container = document.getElementById('tipMenu');
    const actionNames = {
        "flash_seins": "Flash Seins",
        "flash_fesses": "Flash Fesses",
        "strip_complet": "Strip Complet",
        "toy_show": "Toy Show",
        "prive_5min": "Prive 5min",
        "prive_10min": "Prive 10min",
        "ahegao": "Ahegao",
        "costume_change": "Costume",
        "no_panties": "No Panties",
        "twerk": "Twerk",
        "pole_dance": "Pole Dance",
        "oil_show": "Oil Show",
        "squirt_show": "Squirt",
        "reponse": "Reponse",
        "ordre_perso": "Ordre Perso",
        "humiliation": "Humiliation",
        "prive_domination": "Domination",
        "conseil_sexe": "Conseil",
        "strip_elegant": "Strip Elegant",
        "dirty_talk_mature": "Dirty Talk",
        "roleplay_mom": "Roleplay"
    };
    
    let html = '';
    for (const [action, tokens] of Object.entries(tipMenu)) {
        const name = actionNames[action] || action;
        html += `<button class="tip-btn" onclick="sendTip('${action}', ${tokens})">
            ${name} <span>${tokens} tk</span>
        </button>`;
    }
    container.innerHTML = html;
}

async function sendTip(action, tokens) {
    if (!currentCamgirl) return;
    
    const chatEl = document.getElementById('camgirlChat');
    chatEl.innerHTML += `<div class="cam-msg tip"><span class="user">Toi:</span> A envoye ${tokens} tokens pour ${action}!</div>`;
    
    try {
        const res = await fetch('/api/send_tip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                girl_id: currentCamgirl,
                action: action,
                tokens: tokens
            })
        });
        const data = await res.json();
        if (data.response) {
            chatEl.innerHTML += `<div class="cam-msg"><span class="user">${camgirlsData.find(c => c.girl_id === currentCamgirl)?.name || 'Elle'}:</span> ${data.response}</div>`;
        }
    } catch(e) {
        console.log("Tip error:", e);
    }
    
    chatEl.scrollTop = chatEl.scrollHeight;
}

function closeCamgirlModal() {
    document.getElementById('camgirlModal').style.display = 'none';
    currentCamgirl = null;
}

// ============ GALLERY PRIVEE ============
async function loadPrivateGallery() {
    try {
        const res = await fetch('/api/gallery');
        const data = await res.json();
        renderPrivateGallery(data.gallery || {});
    } catch(e) {
        console.log("Gallery load error:", e);
        renderPrivateGallery({});
    }
}

function renderPrivateGallery(gallery) {
    const container = document.getElementById('photosGallery');
    const noPhotos = document.getElementById('noPhotosText');
    if (!container) return;
    
    const hasPhotos = Object.keys(gallery).length > 0;
    
    if (!hasPhotos) {
        container.innerHTML = '';
        if (noPhotos) noPhotos.style.display = 'block';
        return;
    }
    
    if (noPhotos) noPhotos.style.display = 'none';
    
    let html = '<h2>Ta Galerie Privee</h2>';
    
    for (const [girlId, photos] of Object.entries(gallery)) {
        const girl = GIRLS[girlId];
        const name = girl?.name || girlId;
        
        html += `<div class="gallery-section">
            <div class="gallery-section-title">${name} (${photos.length} photos)</div>
            <div class="photos-grid">`;
        
        photos.forEach(photo => {
            html += `<div class="gallery-photo" onclick="viewFullPhoto('${photo}')">
                <img src="${photo}" alt="Photo" loading="lazy">
            </div>`;
        });
        
        html += `</div></div>`;
    }
    
    container.innerHTML = html;
}

function viewFullPhoto(url) {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:3000;display:flex;align-items:center;justify-content:center;';
    overlay.innerHTML = `<img src="${url}" style="max-width:95%;max-height:95%;object-fit:contain;">
        <button onclick="this.parentElement.remove()" style="position:absolute;top:20px;right:20px;background:none;border:none;color:white;font-size:2rem;cursor:pointer;">X</button>`;
    document.body.appendChild(overlay);
}

// ============ ORIGINAL INIT EXTENSION ============
const origNavigateTo = window.navigateTo;
window.navigateTo = function(page) {
    if (page === 'camgirls') {
        loadCamgirls();
    }
    if (page === 'gallery') {
        loadPrivateGallery();
    }
    
    const pageMap = {
        'discover': 'pageDiscover',
        'messages': 'pageMessages',
        'matches': 'pageMatches',
        'camgirls': 'pageCamgirls',
        'gallery': 'pageGallery',
        'settings': 'pageSettings'
    };
    
    const pageId = pageMap[page];
    if (!pageId) return;
    
    document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active', 'page-enter', 'page-exit');
        p.style.display = 'none';
    });
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    const navBtn = document.getElementById('nav' + page.charAt(0).toUpperCase() + page.slice(1));
    if (navBtn) navBtn.classList.add('active');
    
    const pageEl = document.getElementById(pageId);
    if (pageEl) {
        pageEl.style.display = 'block';
        pageEl.classList.add('active', 'page-enter');
    }
};

// ============ CHARACTER CREATOR ============
function openCharacterCreator() {
    document.getElementById('characterCreatorModal').style.display = 'flex';
}

function closeCharacterCreator() {
    document.getElementById('characterCreatorModal').style.display = 'none';
}

async function createCharacter() {
    const name = document.getElementById('charName').value.trim();
    const age = parseInt(document.getElementById('charAge').value);
    const ethnicity = document.getElementById('charEthnicity').value;
    const body = document.getElementById('charBody').value;
    const breast = document.getElementById('charBreast').value;
    const hair = document.getElementById('charHair').value;
    const archetype = document.getElementById('charArchetype').value;
    
    if (!name) {
        showToast("Entre un prenom");
        return;
    }
    if (age < 18 || age > 50) {
        showToast("Age entre 18 et 50");
        return;
    }
    
    showToast("Creation en cours...");
    
    try {
        const res = await fetch('/api/character/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                age: age,
                ethnicity: ethnicity,
                body_type: body,
                breast_size: breast,
                hair_color: hair,
                archetype: archetype
            })
        });
        
        const data = await res.json();
        if (data.success) {
            showToast(name + " a ete creee!");
            closeCharacterCreator();
            GIRLS[data.girl_id] = data.girl;
            navigateTo('discover');
        } else {
            showToast(data.error || "Erreur de creation");
        }
    } catch(e) {
        console.log("Character creation error:", e);
        showToast("Erreur de connexion");
    }
}

// Load stories on init
setTimeout(() => {
    loadStories();
}, 1000);

init();
</script>
</body>
</html>
